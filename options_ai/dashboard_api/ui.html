<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OptionsPredicator</title>

  <style>
    :root {
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --radius: 12px;
      --radius-sm: 10px;
      --shadow: 0 8px 24px rgba(0,0,0,0.18);
      --shadow-sm: 0 4px 14px rgba(0,0,0,0.14);
      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --bg: #0b1020;
      --surface: #111a33;
      --surface-2: #0f1730;
      --text: #e7ecff;
      --muted: #a6b0d6;
      --border: rgba(255,255,255,0.10);
      --divider: rgba(255,255,255,0.06);

      --primary: #60a5fa;
      --primary-2: #2563eb;

      --success: #22c55e;
      --warn: #f59e0b;
      --error: #ef4444;
      --info: #38bdf8;

      --btn-bg: rgba(255,255,255,0.08);
      --btn-bg-hover: rgba(255,255,255,0.12);
      --btn-border: rgba(255,255,255,0.14);
    }

    html[data-theme="light"] {
      --bg: #f7f8fc;
      --surface: #ffffff;
      --surface-2: #f1f5ff;
      --text: #0b1020;
      --muted: #41507a;
      --border: rgba(15, 23, 42, 0.14);
      --divider: rgba(15, 23, 42, 0.08);

      --btn-bg: rgba(15, 23, 42, 0.06);
      --btn-bg-hover: rgba(15, 23, 42, 0.10);
      --btn-border: rgba(15, 23, 42, 0.16);

      --shadow: 0 10px 30px rgba(15,23,42,0.10);
      --shadow-sm: 0 6px 18px rgba(15,23,42,0.08);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
    }

    a { color: inherit; text-decoration: none; }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 56px 1fr;
      height: 100vh;
    }

    .appbar {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-4);
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(8px);
    }

    .brand {
      display: flex;
      gap: var(--space-3);
      align-items: baseline;
    }
    .brand h1 {
      font-size: 16px;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .brand .sub {
      font-size: 12px;
      color: var(--muted);
    }

    .status {
      display: flex;
      gap: var(--space-3);
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.18);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      color: var(--muted);
    }
    .badge strong { color: var(--text); font-weight: 600; }

    .sidebar {
      grid-row: 2;
      padding: var(--space-4);
      border-right: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: var(--space-2);
    }

    .nav a {
      padding: 10px 12px;
      border-radius: 10px;
      color: var(--muted);
      border: 1px solid transparent;
    }

    .nav a.active {
      color: var(--text);
      background: rgba(96,165,250,0.12);
      border-color: rgba(96,165,250,0.30);
    }

    .nav a:hover {
      background: rgba(255,255,255,0.06);
    }

    .content {
      grid-row: 2;
      overflow: auto;
      padding: var(--space-4);
    }

    .banner {
      display: none;
      margin-bottom: var(--space-3);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(239,68,68,0.35);
      background: rgba(239,68,68,0.12);
      color: var(--text);
      font-size: 12px;
      white-space: pre-wrap;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    .grid1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .card .card-h {
      padding: 12px 14px;
      border-bottom: 1px solid var(--divider);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: var(--space-3);
    }

    .card .card-h h2 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    .card .card-h .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .card .card-b {
      padding: 14px;
    }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
    }

    label { font-size: 12px; color: var(--muted); }

    input, select {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--btn-border);
      border-radius: 10px;
      padding: 8px 10px;
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus {
      border-color: rgba(96,165,250,0.55);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
    }

    button {
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: var(--btn-bg-hover); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn-primary { background: rgba(96,165,250,0.18); border-color: rgba(96,165,250,0.35); }
    .btn-danger { background: rgba(239,68,68,0.16); border-color: rgba(239,68,68,0.34); }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead th {
      position: sticky;
      top: 0;
      background: var(--surface);
      border-bottom: 1px solid var(--divider);
      text-align: left;
      padding: 8px;
      color: var(--muted);
      font-weight: 600;
    }
    tbody td {
      border-bottom: 1px solid var(--divider);
      padding: 8px;
    }
    tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }
    tbody tr:hover { background: rgba(96,165,250,0.06); }

    .logs {
      max-height: 520px;
      overflow: auto;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 12px;
    }
    .logs .line { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }

    .toast-wrap {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    .toast {
      width: min(420px, calc(100vw - 40px));
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(17,26,51,0.92);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 12px;
    }

    .toast.success { border-color: rgba(34,197,94,0.35); }
    .toast.error { border-color: rgba(239,68,68,0.35); }
    .toast.warn { border-color: rgba(245,158,11,0.35); }

    .view { display: none; }
    .view.active { display: block; }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 56px auto 1fr; }
      .sidebar { grid-row: 2; border-right: none; border-bottom: 1px solid var(--border); }
      .content { grid-row: 3; }
      .grid2 { grid-template-columns: 1fr; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="toast-wrap" id="toastWrap"></div>

  <div class="app">
    <div class="appbar">
      <div class="brand">
        <h1>OptionsPredicator</h1>
        <div class="sub">Dashboard</div>
      </div>

      <div class="status">
        <div class="badge"><span class="dot" id="healthDot"></span> <strong id="healthText">Unknown</strong></div>
        <div class="badge">Paused: <strong id="pausedText">—</strong></div>
        <div class="badge">Last refresh: <strong id="lastRefresh">—</strong></div>
        <button id="themeToggle">Theme</button>
      </div>
    </div>

    <aside class="sidebar">
      <div class="badge" style="width:100%; justify-content:space-between;">
        <span>Navigation</span>
        <span style="font-family:var(--mono); font-size:11px;" id="apiTz">CT</span>
      </div>
      <nav class="nav" id="nav">
        <a href="#overview" data-view="overview" class="active">Overview</a>
        <a href="#debit" data-view="debit">Debit Spreads</a>
        <a href="#processing" data-view="processing">Processing</a>
        <a href="#timeseries" data-view="timeseries">Time Series</a>
        <a href="#logs" data-view="logs">Logs</a>
        <a href="#controls" data-view="controls">Controls & Admin</a>
      </nav>
    </aside>

    <main class="content">
      <div class="banner" id="errorBanner"></div>

      <!-- OVERVIEW -->
      <section class="view active" id="view-overview">
        <div class="grid2">
          <div class="card">
            <div class="card-h"><h2>Processing</h2><div class="hint">Queue + scoring status</div></div>
            <div class="card-b">
              <div class="row">
                <div>Queue: <span id="queueCount" class="pill">-</span></div>
                <div>Processing: <span id="procCount" class="pill">-</span></div>
                <div>Total predictions: <span id="totPred" class="pill">-</span></div>
                <div>Scored: <span id="totScored" class="pill">-</span></div>
                <div>Unscored: <span id="totUnscored" class="pill">-</span></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <div class="badge">Newest snapshot_index: <strong id="newestSnap">—</strong></div>
                <div class="badge">Oldest unscored: <strong id="oldestUnscored">—</strong></div>
              </div>
              <div style="margin-top:10px; color:var(--muted); font-size:12px;" id="processingBox">(idle)</div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>Tokens / Hour (est.)</h2><div class="hint">Estimated from chars (DeepSeek endpoint doesn’t return usage)</div></div>
            <div class="card-b">
              <div style="display:flex; justify-content:space-between; align-items:baseline;">
                <div style="font-size:38px; font-weight:750;" id="tokTotal">—</div>
                <div style="text-align:right;">
                  <div class="hint" id="tokAvg">avg/file: —</div>
                  <div class="hint" id="tokTrend">trend: —</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top: var(--space-4);">
          <div class="card">
            <div class="card-h"><h2>LLM Rolling (N)</h2><div class="hint">Bucketed by observed_ts_utc (event time)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Rolling N <input id="rollingN" type="number" min="10" max="5000" value="50" style="width:90px;" /></label>
                <button class="btn-primary" id="refreshMetrics">Refresh</button>
                <span class="hint" id="metricsAsOf"></span>
              </div>
              <div class="row" style="margin-top:10px;">
                <div>Overall: <span id="rollOverall" class="pill">—</span></div>
                <div>Excl inconc: <span id="rollExcl" class="pill">—</span></div>
                <div>Hi-conf: <span id="rollHi" class="pill">—</span></div>
                <div>Total: <span id="rollTotal" class="pill">—</span></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>ML Rolling (N)</h2><div class="hint">Neutral-often / action gating</div></div>
            <div class="card-b">
              <div class="row" style="margin-top:4px;">
                <div>Action rate: <span id="mlActionRate" class="pill">—</span></div>
                <div>Acc (actionable): <span id="mlAccAction" class="pill">—</span></div>
                <div>Overall acc: <span id="mlOverall" class="pill">—</span></div>
                <div>Scored: <span id="mlTotal" class="pill">—</span></div>
              </div>
              <div class="hint" style="margin-top:10px;">See Models tab for charts.</div>
            </div>
          </div>


          <div class="card" style="margin-top: var(--space-4);">
            <div class="card-h">
              <h2>Trade History (30m)</h2>
              <div class="hint">Realized outcomes; optional “only trades I'd take” filter</div>
            </div>
            <div class="card-b">
              <div class="row">
                <label>Limit <input id="debitHistLimit" type="number" min="1" max="500" value="100" style="width:90px;" /></label>
                <label><input id="debitHistOnlyReco" type="checkbox" /> Only trades I'd take</label>
                <button class="btn-primary" id="refreshDebitHistoryBtn">Refresh</button>
                <span class="hint" id="debitHistSummary"></span>
              </div>
              <div style="margin-top:12px;">
                <table>
                  <thead>
                    <tr>
                      <th>snapshot</th><th>anchor</th><th>type</th>
                      <th>debit_t</th><th>debit_tH</th><th>chg</th><th>roi</th>
                      <th>p(bigwin)</th><th>pred(30m)</th>
                    </tr>
                  </thead>
                  <tbody id="debitHistTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROCESSING -->
      <section class="view" id="view-processing">
        <div class="grid1">
          <div class="card">
            <div class="card-h">
              <h2>Processing</h2>
              <div class="hint">Queue oldest-first + paging</div>
            </div>
            <div class="card-b">
              <div class="row" style="justify-content:space-between;">
                <div class="row">
                  <div>Queue: <span class="pill" id="queueCount2">—</span></div>
                  <div>Processing: <span class="pill" id="procCount2">—</span></div>
                </div>
                <div class="row">
                  <label>Order
                    <select id="queueOrder">
                      <option value="oldest" selected>Oldest</option>
                      <option value="newest">Newest</option>
                    </select>
                  </label>
                  <label>Page <input id="queuePage" type="number" min="1" value="1" style="width:70px;" /></label>
                  <label>Page size <input id="queuePageSize" type="number" min="10" max="200" value="50" style="width:80px;" /></label>
                  <button id="refreshProcessingBtn">Refresh</button>
                </div>
              </div>

              <div style="margin-top:10px;">
                <table>
                  <thead><tr><th>file</th><th>size</th><th>mtime</th></tr></thead>
                  <tbody id="queueTable"></tbody>
                </table>
              </div>

              <div style="margin-top:14px;" class="row">
                <div class="badge">Newest snapshot_index: <strong id="newestSnap2">—</strong></div>
                <div class="badge">Oldest unscored: <strong id="oldestUnscored2">—</strong></div>
              </div>

              <div style="margin-top:12px;" class="badge">Currently processing: <strong id="processingBox2">—</strong></div>
            </div>
          </div>
        </div>
      </section>

      <!-- TIME SERIES -->
      <section class="view" id="view-timeseries">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>LLM Metrics</h2><div class="hint">15m buckets + daily (event time)</div></div>
            <div class="card-b">
          <div class="card">
            <div class="card-h"><h2>LLM Metrics</h2><div class="hint">Bucketed by observed_ts_utc (event time)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Window days <input id="llmWinDays" type="number" min="1" max="60" value="15" style="width:80px;" /></label>
                <label>Bucket
                  <select id="llmBucketMin">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="30">30</option>
                    <option value="60">60</option>
                  </select>
                </label>
                <label>Min samples <input id="llmMinSamples" type="number" min="1" max="200" value="5" style="width:80px;" /></label>
                <button class="btn-primary" id="refreshLlmBuckets">Refresh 15m</button>
              </div>
              <div style="margin-top:12px;">
                <canvas id="llmBucketChart" height="120"></canvas>
              </div>

              <div style="margin-top:16px;">
                <canvas id="dailyChart" height="120"></canvas>
              </div>
            </div>
          </div>
        
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>ML Metrics</h2><div class="hint">15m buckets + daily + EOD (Central)</div></div>
            <div class="card-b">
          <div class="card">
            <div class="card-h"><h2>ML (15m)</h2><div class="hint">Bucketed by observed_ts_utc</div></div>
            <div class="card-b">
              <div class="row">
                <label>Window days <input id="mlWinDays" type="number" min="1" max="60" value="15" style="width:80px;" /></label>
                <label>Bucket
                  <select id="mlBucketMin">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="30">30</option>
                    <option value="60">60</option>
                  </select>
                </label>
                <label>Min samples <input id="mlMinSamples" type="number" min="1" max="200" value="5" style="width:80px;" /></label>
                <button class="btn-primary" id="refreshMlBuckets">Refresh 15m</button>
              </div>
              <div style="margin-top:12px;">
                <canvas id="mlBucketChart" height="120"></canvas>
              </div>
              <div style="margin-top:16px;">
                <canvas id="mlDailyChart" height="120"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>ML EOD (Early 60m)</h2><div class="hint">trade_day bucket (Central)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Variant
                  <select id="eodVariant">
                    <option value="lvl0" selected>lvl0</option>
                    <option value="lvl1">lvl1</option>
                  </select>
                </label>
                <label>Days <input id="eodDays" type="number" min="5" max="120" value="30" style="width:80px;" /></label>
                <button class="btn-primary" id="refreshEod">Refresh</button>
              </div>
              <div class="row" style="margin-top:10px;">
                <div>Action rate: <span id="eodActionRate" class="pill">—</span></div>
                <div>Acc (actionable): <span id="eodAccAction" class="pill">—</span></div>
                <div>Overall acc: <span id="eodOverall" class="pill">—</span></div>
              </div>
              <div style="margin-top:14px;">
                <canvas id="eodDailyChart" height="120"></canvas>
              </div>
            </div>
          </div>
        
            </div>
          </div>
        </div>
      </section>

      

      <!-- DEBIT SPREADS -->
      <section class="view" id="view-debit">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>0DTE Levels</h2><div class="hint">ATM / Call Wall / Put Wall / Magnet</div></div>
            <div class="card-b">
              <div class="row">
                <div class="badge">Snapshot: <strong id="debitSnapshot">—</strong></div>
                <div class="badge">Exp: <strong id="debitExp">—</strong></div>
                <div class="badge">Spot: <strong id="debitSpot">—</strong></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <div class="badge">ATM: <strong id="lvlAtm">—</strong></div>
                <div class="badge">CALL_WALL: <strong id="lvlCallWall">—</strong></div>
                <div class="badge">PUT_WALL: <strong id="lvlPutWall">—</strong></div>
                <div class="badge">MAGNET: <strong id="lvlMagnet">—</strong></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>Top Tradable Candidates</h2><div class="hint">tradable=true (ranked by 30m change when available, else debit)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Limit <input id="debitLimit" type="number" min="1" max="100" value="12" style="width:90px;" /></label>
                <button class="btn-primary" id="refreshDebit">Refresh</button>
                <span class="hint" id="debitNote"></span>
              </div>
              <div style="margin-top:12px;">
                <table>
                  <thead>
                    <tr>
                      <th>anchor</th>
                      <th>type</th>
                      <th>k_long</th>
                      <th>k_short</th>
                      <th>debit</th>
                      <th>p(bigwin)</th>
                      <th>pred(30m)</th>
                      <th>chg(30m)</th>
                      <th>long_symbol</th>
                      <th>short_symbol</th>
                    </tr>
                  </thead>
                  <tbody id="debitTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

<!-- LOGS -->
      <section class="view" id="view-logs">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>Logs</h2><div class="hint">Tail-only (whitelisted)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Log
                  <select id="logName">
                    <option value="errors">errors</option>
                    <option value="system">system</option>
                    <option value="routing">routing</option>
                    <option value="model">model</option>
                    <option value="scoring">scoring</option>
                    <option value="performance">performance</option>
                    <option value="bootstrap">bootstrap</option>
                  </select>
                </label>
                <label>Lines <input id="logLimit" type="number" min="10" max="2000" value="200" style="width:90px;" /></label>
                <label>Search <input id="logSearch" type="text" placeholder="filter (client-side)" /></label>
                <label><input id="logAuto" type="checkbox" /> auto-refresh</label>
                <button class="btn-primary" id="refreshLogs">Refresh</button>
              </div>
              <div class="logs" id="logBox" style="margin-top: 12px;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CONTROLS -->
      <section class="view" id="view-controls">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>Runtime Controls</h2><div class="hint">Always visible (may be gated/disabled)</div></div>
            <div class="card-b">
              <div class="row">
                <label><input id="llmEnabled" type="checkbox" /> LLM_ENABLED</label>
                <label><input id="mlEnabled" type="checkbox" /> ML_ENABLED</label>
                <label><input id="chartEnabled" type="checkbox" /> CHART_ENABLED (requires LLM)</label>
                <label><input id="pauseProcessing" type="checkbox" /> PAUSE_PROCESSING</label>
              </div>

              <div class="row" style="margin-top:12px;">
                <label>REPROCESS_MODE
                  <select id="reprocessMode">
                    <option value="none">none</option>
                    <option value="from_model">from_model</option>
                    <option value="from_summary">from_summary</option>
                    <option value="from_signals">from_signals</option>
                    <option value="full">full</option>
                  </select>
                </label>
                <label>WATCH_POLL_SECONDS <input id="watchPoll" type="number" step="0.05" min="0.05" max="60" value="1" style="width:90px;" /></label>
                <label>FILE_STABLE_SECONDS <input id="fileStable" type="number" min="0" max="60" value="2" style="width:90px;" /></label>
                <label>OUTCOME_DELAY <input id="outcomeDelay" type="number" min="1" max="240" value="15" style="width:90px;" /></label>
              </div>

              <div class="row" style="margin-top:12px;">
                <button class="btn-primary" id="applyOverrides">Apply</button>
                <button id="clearReprocess">Clear REPROCESS override</button>
                <span class="hint" id="cfgStatus"></span>
              </div>

              <div style="margin-top:12px;" class="badge">Effective config snippet: <strong id="cfgSnippetInline">(loading)</strong></div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>Admin</h2><div class="hint">Danger zone</div></div>
            <div class="card-b">
              <div style="color:var(--muted); font-size:12px;">Irreversible. Deletes DB rows + files. Requires PAUSE_PROCESSING=true and typed confirmation.</div>
              <div class="row" style="margin-top:12px;">
                <input id="resetConfirm" type="text" placeholder="Type: RESET ALL DATA" style="min-width:240px;" />
                <button class="btn-danger" id="runReset">Run Full Reset</button>
                <span class="hint" id="resetGateText">(loading gate)</span>
              </div>
              <pre id="resetStatus" style="margin-top:10px; font-family: var(--mono); font-size: 12px; color: var(--muted);">(reset output)</pre>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    const api = '';

    function setTheme(theme) {
      const t = theme === 'light' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
    }

    function initTheme() {
      const saved = localStorage.getItem('theme');
      setTheme(saved || 'dark');
    }

    function toast(msg, kind='success') {
      const wrap = document.getElementById('toastWrap');
      if (!wrap) return;
      const el = document.createElement('div');
      el.className = `toast ${kind}`;
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(() => el.remove(), 4500);
    }

    function showError(where, err) {
      const b = document.getElementById('errorBanner');
      if (!b) return;
      const msg = (err && (err.message || err.toString())) ? (err.message || err.toString()) : String(err);
      const t = new Date().toISOString();
      b.style.display = 'block';
      b.textContent = `[${t}] ${where}: ${msg}`;
    }

    async function safe(where, fn) {
      try {
        const r = await fn();
        // stamp last refresh if it succeeded
        document.getElementById('lastRefresh').textContent = new Date().toLocaleString();
        return r;
      } catch (e) {
        console.error(where, e);
        showError(where, e);
        return null;
      }
    }

    function chartsAvailable() {
      return (typeof Chart !== 'undefined');
    }

    function fmtNum(x, nd=2) {
      if (x === null || x === undefined) return '—';
      const v = Number(x);
      if (!isFinite(v)) return '—';
      return v.toFixed(nd);
    }

    function fmtPct(x) {
      if (x === null || x === undefined) return '—';
      return (100.0 * x).toFixed(1) + '%';
    }

    async function jget(path) {
      const r = await fetch(api + path);
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function jpatch(path, obj) {
      const r = await fetch(api + path, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(obj)
      });
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function jpost(path, obj) {
      const r = await fetch(api + path, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(obj)
      });
      const txt = await r.text();
      if (!r.ok) throw new Error(txt);
      try { return JSON.parse(txt); } catch { return {raw: txt}; }
    }

    function setActiveView(view) {
      document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
      const v = document.getElementById(`view-${view}`);
      if (v) v.classList.add('active');

      document.querySelectorAll('#nav a').forEach(a => a.classList.remove('active'));
      const link = document.querySelector(`#nav a[data-view="${view}"]`);
      if (link) link.classList.add('active');
    }

    function routeFromHash() {
      const h = (window.location.hash || '#overview').replace('#','');
      const allowed = new Set(['overview','debit','processing','timeseries','logs','controls']);
      setActiveView(allowed.has(h) ? h : 'overview');
    }

    // Health + gating
    let resetEnabled = false;

    async function refreshHealth() {
      const data = await jget('/api/health');
      const ok = !!data.ok;
      resetEnabled = !!data.reset_enabled;
      const paused = !!data.paused;

      const apiTzEl = document.getElementById('apiTz');
      if (apiTzEl) apiTzEl.textContent = data.tz === 'America/Chicago' ? 'CT' : (data.tz || '');
      const pausedEl = document.getElementById('pausedText');
      if (pausedEl) pausedEl.textContent = paused ? 'YES' : 'NO';

      const dot = document.getElementById('healthDot');
      const ht = document.getElementById('healthText');
      if (!dot || !ht) return data;
      if (!ok) {
        dot.style.background = 'var(--error)';
        dot.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.18)';
        ht.textContent = 'DOWN';
      } else if (paused) {
        dot.style.background = 'var(--warn)';
        dot.style.boxShadow = '0 0 0 3px rgba(245,158,11,0.18)';
        ht.textContent = 'OK (paused)';
      } else {
        dot.style.background = 'var(--success)';
        dot.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.18)';
        ht.textContent = 'OK';
      }

      const gateText = document.getElementById('resetGateText');
      const btn = document.getElementById('runReset');
      if (gateText && btn) {
        if (!resetEnabled) {
          gateText.textContent = 'RESET_ENABLED=false on server (enable in /opt/OptionsPredicator/.env)';
          btn.disabled = true;
        } else {
          gateText.textContent = 'RESET_ENABLED=true (still requires PAUSE_PROCESSING + typed confirm)';
          btn.disabled = false;
        }
      }

      return data;
    }

    // Debit spreads (TimescaleDB)
    async function refreshDebitHistory() {
      const lim = parseInt(document.getElementById('debitHistLimit')?.value || '100', 10);
      const onlyReco = document.getElementById('debitHistOnlyReco')?.checked ? '1' : '0';
      const data = await jget(`/api/debit_spreads/history?limit=${lim}&horizon_minutes=30&only_recommended=${onlyReco}`);

      const tb = document.getElementById('debitHistTable');
      if (!tb) return data;
      tb.innerHTML = '';

      for (const it of (data.items || [])) {
        const tr = document.createElement('tr');
        const roi = (it.roi === null || it.roi === undefined) ? '—' : (100*Number(it.roi)).toFixed(1) + '%';
        const pbig = (it.p_bigwin === null || it.p_bigwin === undefined) ? '—' : (100*Number(it.p_bigwin)).toFixed(1) + '%';
        const pred = (it.pred_change === null || it.pred_change === undefined) ? '—' : fmtNum(it.pred_change, 2);
        tr.innerHTML = `
          <td>${it.snapshot_ts || ''}</td>
          <td>${it.anchor_type || ''}</td>
          <td>${it.spread_type || ''}</td>
          <td>${it.debit_t === null || it.debit_t === undefined ? '—' : fmtNum(it.debit_t, 2)}</td>
          <td>${it.debit_tH === null || it.debit_tH === undefined ? '—' : fmtNum(it.debit_tH, 2)}</td>
          <td>${it.change === null || it.change === undefined ? '—' : fmtNum(it.change, 2)}</td>
          <td>${roi}</td>
          <td>${pbig}</td>
          <td>${pred}</td>
        `;
        tb.appendChild(tr);
      }

      const sum = document.getElementById('debitHistSummary');
      if (sum) sum.textContent = `${(data.items||[]).length} rows`;
      return data;
    }


    async function refreshDebitSpreads() {
      const lim = parseInt(document.getElementById('debitLimit')?.value || '12', 10);
      const data = await jget(`/api/debit_spreads/top?limit=${lim}`);

      document.getElementById('debitSnapshot').textContent = data.snapshot_ts || '—';
      const lev = data.levels || {};
      document.getElementById('debitExp').textContent = lev.expiration_date || '—';
      document.getElementById('debitSpot').textContent = (lev.spot === null || lev.spot === undefined) ? '—' : fmtNum(lev.spot, 2);
      document.getElementById('lvlAtm').textContent = (lev.atm === null || lev.atm === undefined) ? '—' : fmtNum(lev.atm, 0);
      document.getElementById('lvlCallWall').textContent = (lev.call_wall === null || lev.call_wall === undefined) ? '—' : fmtNum(lev.call_wall, 0);
      document.getElementById('lvlPutWall').textContent = (lev.put_wall === null || lev.put_wall === undefined) ? '—' : fmtNum(lev.put_wall, 0);
      document.getElementById('lvlMagnet').textContent = (lev.magnet === null || lev.magnet === undefined) ? '—' : fmtNum(lev.magnet, 0);

      const tb = document.getElementById('debitTable');
      tb.innerHTML = '';
      for (const it of (data.candidates || [])) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.anchor_type || ''}</td>
          <td>${it.spread_type || ''}</td>
          <td>${it.k_long === null || it.k_long === undefined ? '—' : fmtNum(it.k_long, 0)}</td>
          <td>${it.k_short === null || it.k_short === undefined ? '—' : fmtNum(it.k_short, 0)}</td>
          <td>${it.debit_points === null || it.debit_points === undefined ? '—' : fmtNum(it.debit_points, 2)}</td>
          <td>${it.p_bigwin === null || it.p_bigwin === undefined ? '—' : (100*Number(it.p_bigwin)).toFixed(1) + '%'}</td>
          <td>${it.pred_change === null || it.pred_change === undefined ? '—' : fmtNum(it.pred_change, 2)}</td>
          <td>${it.change === null || it.change === undefined ? (it.is_missing_future ? '—' : '…') : fmtNum(it.change, 2)}</td>
          <td style="font-family:var(--mono); font-size:11px;">${it.long_symbol || ''}</td>
          <td style="font-family:var(--mono); font-size:11px;">${it.short_symbol || ''}</td>
        `;
        tb.appendChild(tr);
      }

      const note = document.getElementById('debitNote');
      if (note) {
        note.textContent = (data.snapshot_ts ? 'latest snapshot' : 'no data yet');
      }

      return data;
    }

// Processing
    async function refreshProcessing() {
      const order = document.getElementById('queueOrder')?.value || 'oldest';
      const page = parseInt(document.getElementById('queuePage')?.value || '1', 10);
      const page_size = parseInt(document.getElementById('queuePageSize')?.value || '50', 10);
      const data = await jget(`/api/status/processing?page=${page}&page_size=${page_size}&order=${order}`);

      // Overview counters
      document.getElementById('queueCount').textContent = data.queue.count;
      document.getElementById('procCount').textContent = data.processing.count;
      document.getElementById('totPred').textContent = data.counters.total_predictions;
      document.getElementById('totScored').textContent = data.counters.total_scored;
      document.getElementById('totUnscored').textContent = data.counters.unscored;

      // Processing page counters
      const qc2 = document.getElementById('queueCount2');
      const pc2 = document.getElementById('procCount2');
      if (qc2) qc2.textContent = data.queue.count;
      if (pc2) pc2.textContent = data.processing.count;

      document.getElementById('newestSnap').textContent = data.snapshot_index_newest_ts || '—';
      document.getElementById('oldestUnscored').textContent = data.oldest_unscored_ts || '—';
      const ns2 = document.getElementById('newestSnap2');
      const ou2 = document.getElementById('oldestUnscored2');
      if (ns2) ns2.textContent = data.snapshot_index_newest_ts || '—';
      if (ou2) ou2.textContent = data.oldest_unscored_ts || '—';

      // Queue table
      const tb = document.getElementById('queueTable');
      tb.innerHTML = '';
      for (const it of (data.queue.items || [])) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.file}</td><td>${it.size}</td><td>${new Date(it.mtime*1000).toISOString()}</td>`;
        tb.appendChild(tr);
      }

      // Currently processing
      const pbox = document.getElementById('processingBox');
      const pbox2 = document.getElementById('processingBox2');
      if ((data.processing.items || []).length === 0) {
        const msg = 'idle / not available';
        if (pbox) pbox.textContent = msg;
        if (pbox2) pbox2.textContent = msg;
      } else {
        const it = data.processing.items[0];
        const msg = `${it.file} | stage=${it.stage} | started=${it.started_at} | elapsed=${(it.elapsed_seconds ?? 0).toFixed(1)}s`;
        if (pbox) pbox.textContent = msg;
        if (pbox2) pbox2.textContent = msg;
      }

      return data;
    }

    // Tokens tile
    async function refreshTokens() {
      const data = await jget('/api/usage/tokens?hours=24');
      const s = data.summary || {};
      document.getElementById('tokTotal').textContent = (s.est_total_tokens_last_60m ?? 0).toLocaleString();
      const avg = s.avg_est_tokens_per_file_last_60m;
      document.getElementById('tokAvg').textContent = 'avg/file: ' + (avg === null || avg === undefined ? '—' : Math.round(avg).toLocaleString());
      const tr = s.trend_vs_prev_hour_pct;
      if (tr === null || tr === undefined) {
        document.getElementById('tokTrend').textContent = 'trend: —';
      } else {
        const pct = (100*tr).toFixed(1);
        document.getElementById('tokTrend').textContent = 'trend: ' + (tr>=0?'+':'') + pct + '% vs prev hr';
      }
      return data;
    }

    // LLM daily chart + rolling
    let dailyChart;
    async function refreshMetrics() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }

      const n = parseInt(document.getElementById('rollingN').value || '50', 10);
      const roll = await jget(`/api/metrics/rolling?n=${n}`);
      document.getElementById('metricsAsOf').textContent = roll.as_of ? `as_of ${roll.as_of}` : '';
      document.getElementById('rollOverall').textContent = fmtPct(roll.overall_accuracy);
      document.getElementById('rollExcl').textContent = fmtPct(roll.accuracy_excluding_inconclusive);
      document.getElementById('rollHi').textContent = fmtPct(roll.hi_accuracy);
      document.getElementById('rollTotal').textContent = roll.total_scored;

      const daily = await jget('/api/metrics/daily?days=30');
      const labels = daily.series.map(x => x.day).reverse();
      const overall = daily.series.map(x => x.overall_accuracy).reverse();
      const excl = daily.series.map(x => x.accuracy_excluding_inconclusive).reverse();

      const ctx = document.getElementById('dailyChart');
      if (!dailyChart) {
        dailyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'overall_accuracy', data: overall, borderColor: '#60a5fa', tension: 0.2 },
              { label: 'accuracy_excl_inconclusive', data: excl, borderColor: '#22c55e', tension: 0.2 },
            ]
          },
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        dailyChart.data.labels = labels;
        dailyChart.data.datasets[0].data = overall;
        dailyChart.data.datasets[1].data = excl;
        dailyChart.update();
      }

      return {roll, daily};
    }

    // LLM bucket series
    let llmBucketChart;
    async function refreshLlmBuckets() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }
      const wd = parseInt(document.getElementById('llmWinDays')?.value || '15', 10);
      const bm = parseInt(document.getElementById('llmBucketMin')?.value || '15', 10);
      const ms = parseInt(document.getElementById('llmMinSamples')?.value || '5', 10);
      const data = await jget(`/api/metrics/series_buckets?window_days=${wd}&bucket_minutes=${bm}&min_samples=${ms}`);
      const labels = (data.series || []).map(x => x.bucket_start);
      const overall = (data.series || []).map(x => x.overall_accuracy);
      const excl = (data.series || []).map(x => x.accuracy_excluding_inconclusive);

      const ctx = document.getElementById('llmBucketChart');
      if (!llmBucketChart) {
        llmBucketChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
            { label: 'overall_accuracy', data: overall, borderColor: '#38bdf8', tension: 0.15 },
            { label: 'accuracy_excl_inconclusive', data: excl, borderColor: '#22c55e', tension: 0.15 },
          ]},
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        llmBucketChart.data.labels = labels;
        llmBucketChart.data.datasets[0].data = overall;
        llmBucketChart.data.datasets[1].data = excl;
        llmBucketChart.update();
      }

      return data;
    }

    // ML charts
    let mlDailyChart;
    async function refreshML() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }

      const roll = await jget('/api/ml/metrics/rolling?n=50');
      document.getElementById('mlActionRate').textContent = fmtPct(roll.action_rate);
      document.getElementById('mlAccAction').textContent = fmtPct(roll.accuracy_actionable);
      document.getElementById('mlOverall').textContent = fmtPct(roll.overall_accuracy);
      document.getElementById('mlTotal').textContent = roll.total_scored;

      const daily = await jget('/api/ml/metrics/daily?days=30');
      const labels = daily.series.map(x => x.day).reverse();
      const action = daily.series.map(x => x.action_rate).reverse();
      const acc = daily.series.map(x => x.accuracy_actionable).reverse();

      const ctx = document.getElementById('mlDailyChart');
      if (!mlDailyChart) {
        mlDailyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'action_rate', data: action, borderColor: '#f59e0b', tension: 0.2 },
              { label: 'accuracy_actionable', data: acc, borderColor: '#a855f7', tension: 0.2 },
            ]
          },
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        mlDailyChart.data.labels = labels;
        mlDailyChart.data.datasets[0].data = action;
        mlDailyChart.data.datasets[1].data = acc;
        mlDailyChart.update();
      }

      return {roll, daily};
    }

    let mlBucketChart;
    async function refreshMlBuckets() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }
      const wd = parseInt(document.getElementById('mlWinDays')?.value || '15', 10);
      const bm = parseInt(document.getElementById('mlBucketMin')?.value || '15', 10);
      const ms = parseInt(document.getElementById('mlMinSamples')?.value || '5', 10);
      const data = await jget(`/api/ml/metrics/series_buckets?window_days=${wd}&bucket_minutes=${bm}&min_samples=${ms}`);
      const labels = (data.series || []).map(x => x.bucket_start);
      const ar = (data.series || []).map(x => x.action_rate);
      const aa = (data.series || []).map(x => x.accuracy_actionable);

      const ctx = document.getElementById('mlBucketChart');
      if (!mlBucketChart) {
        mlBucketChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
            { label: 'action_rate', data: ar, borderColor: '#f59e0b', tension: 0.15 },
            { label: 'accuracy_actionable', data: aa, borderColor: '#a855f7', tension: 0.15 },
          ]},
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        mlBucketChart.data.labels = labels;
        mlBucketChart.data.datasets[0].data = ar;
        mlBucketChart.data.datasets[1].data = aa;
        mlBucketChart.update();
      }
      return data;
    }

    // EOD
    let eodDailyChart;
    async function refreshEod() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }
      const variant = document.getElementById('eodVariant')?.value || 'lvl0';
      const days = parseInt(document.getElementById('eodDays')?.value || '30', 10);
      const data = await jget(`/api/ml_eod/metrics/daily?days=${days}&variant=${variant}`);
      const series = (data.series || []).slice().reverse();
      const labels = series.map(x => x.day);
      const ar = series.map(x => x.action_rate);
      const aa = series.map(x => x.accuracy_actionable);

      const last = (data.series || [])[0] || {};
      document.getElementById('eodActionRate').textContent = fmtPct(last.action_rate);
      document.getElementById('eodAccAction').textContent = fmtPct(last.accuracy_actionable);
      document.getElementById('eodOverall').textContent = fmtPct(last.overall_accuracy);

      const ctx = document.getElementById('eodDailyChart');
      if (!eodDailyChart) {
        eodDailyChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
            { label: 'action_rate', data: ar, borderColor: '#f97316', tension: 0.2 },
            { label: 'accuracy_actionable', data: aa, borderColor: '#06b6d4', tension: 0.2 },
          ]},
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        eodDailyChart.data.labels = labels;
        eodDailyChart.data.datasets[0].data = ar;
        eodDailyChart.data.datasets[1].data = aa;
        eodDailyChart.update();
      }
      return data;
    }

    // Logs
    async function refreshLogs() {
      const name = document.getElementById('logName').value;
      const limit = parseInt(document.getElementById('logLimit').value || '200', 10);
      const search = (document.getElementById('logSearch').value || '').toLowerCase();
      const data = await jget(`/api/logs/tail?name=${encodeURIComponent(name)}&limit=${limit}`);

      const box = document.getElementById('logBox');
      box.innerHTML = '';
      for (const l of (data.lines || [])) {
        const raw = l.raw || '';
        if (search && !raw.toLowerCase().includes(search)) continue;
        const div = document.createElement('div');
        div.className = 'line';
        div.textContent = raw;
        box.appendChild(div);
      }
      box.scrollTop = box.scrollHeight;
      return data;
    }

    // Config + overrides
    async function refreshConfig() {
      const data = await jget('/api/config');
      const eff = data.effective;

      document.getElementById('reprocessMode').value = eff.reprocess_mode;
      document.getElementById('watchPoll').value = eff.watch_poll_seconds;
      document.getElementById('fileStable').value = eff.file_stable_seconds;
      document.getElementById('outcomeDelay').value = eff.outcome_delay_minutes;

      document.getElementById('llmEnabled').checked = !!eff.llm_enabled;
      document.getElementById('mlEnabled').checked = !!eff.ml_enabled;
      document.getElementById('chartEnabled').checked = !!eff.chart_enabled;
      document.getElementById('pauseProcessing').checked = !!eff.pause_processing;

      const snippet = {
        pause_processing: eff.pause_processing,
        reprocess_mode: eff.reprocess_mode,
        watch_poll_seconds: eff.watch_poll_seconds,
        file_stable_seconds: eff.file_stable_seconds,
        outcome_delay_minutes: eff.outcome_delay_minutes,
        llm_enabled: eff.llm_enabled,
        ml_enabled: eff.ml_enabled,
        chart_enabled: eff.chart_enabled,
        prompt_version: eff.prompt_version,
      };
      document.getElementById('cfgSnippetInline').textContent = JSON.stringify(snippet);

      // Sync paused badge in appbar
      document.getElementById('pausedText').textContent = eff.pause_processing ? 'YES' : 'NO';

      return data;
    }

    async function applyOverrides() {
      const payload = {
        LLM_ENABLED: !!document.getElementById('llmEnabled').checked,
        ML_ENABLED: !!document.getElementById('mlEnabled').checked,
        CHART_ENABLED: !!document.getElementById('chartEnabled').checked,
        PAUSE_PROCESSING: !!document.getElementById('pauseProcessing').checked,
        REPROCESS_MODE: document.getElementById('reprocessMode').value,
        WATCH_POLL_SECONDS: parseFloat(document.getElementById('watchPoll').value),
        FILE_STABLE_SECONDS: parseInt(document.getElementById('fileStable').value, 10),
        OUTCOME_DELAY: parseInt(document.getElementById('outcomeDelay').value, 10),
      };

      const status = document.getElementById('cfgStatus');
      status.textContent = 'Applying...';
      await jpatch('/api/config', payload);
      status.textContent = 'Applied.';
      toast('Overrides applied', 'success');
      await refreshConfig();
    }

    async function clearReprocess() {
      const status = document.getElementById('cfgStatus');
      status.textContent = 'Clearing...';
      await jpatch('/api/config', {REPROCESS_MODE: null});
      status.textContent = 'Cleared.';
      toast('REPROCESS_MODE cleared', 'success');
      await refreshConfig();
    }

    async function runFullReset() {
      const out = document.getElementById('resetStatus');
      out.textContent = 'Running reset...';

      const confirm = document.getElementById('resetConfirm').value || '';
      const r = await jpost('/api/admin/reset_all', {confirm});
      out.textContent = JSON.stringify(r, null, 2);
      toast('Reset completed (check output)', 'warn');

      // refresh UI after reset
      await safe('refreshConfig', () => refreshConfig());
      await safe('refreshProcessing', () => refreshProcessing());
      await safe('refreshLogs', () => refreshLogs());
    }

    // wiring
    document.getElementById('themeToggle')?.addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(cur === 'dark' ? 'light' : 'dark');
    });

    document.getElementById('refreshMetrics')?.addEventListener('click', () => safe('refreshMetrics', () => refreshMetrics()));
    document.getElementById('refreshLlmBuckets')?.addEventListener('click', () => safe('refreshLlmBuckets', () => refreshLlmBuckets()));
    document.getElementById('refreshMlBuckets')?.addEventListener('click', () => safe('refreshMlBuckets', () => refreshMlBuckets()));
    document.getElementById('refreshEod')?.addEventListener('click', () => safe('refreshEod', () => refreshEod()));
    document.getElementById('refreshLogs')?.addEventListener('click', () => safe('refreshLogs', () => refreshLogs()));
    document.getElementById('refreshDebit')?.addEventListener('click', () => safe('refreshDebitSpreads', () => refreshDebitSpreads()));
    document.getElementById('refreshDebitHistoryBtn')?.addEventListener('click', () => safe('debit_history', () => refreshDebitHistory()));
    document.getElementById('debitHistOnlyReco')?.addEventListener('change', () => safe('debit_history', () => refreshDebitHistory()));
    document.getElementById('applyOverrides')?.addEventListener('click', () => safe('applyOverrides', () => applyOverrides()));
    document.getElementById('clearReprocess')?.addEventListener('click', () => safe('clearReprocess', () => clearReprocess()));
    document.getElementById('runReset')?.addEventListener('click', () => safe('runReset', () => runFullReset()));

    document.getElementById('refreshProcessingBtn')?.addEventListener('click', () => safe('refreshProcessing', () => refreshProcessing()));

    // routing
    window.addEventListener('hashchange', routeFromHash);

    // initial load
    (async () => {
      initTheme();
      routeFromHash();

      await safe('health', () => refreshHealth());
      await safe('config', () => refreshConfig());
      await safe('tokens', () => refreshTokens());
      await safe('processing', () => refreshProcessing());
      await safe('debit', () => refreshDebitSpreads());
      await safe('debit_history', () => refreshDebitHistory());
      await safe('llmBuckets', () => refreshLlmBuckets());
      await safe('llmMetrics', () => refreshMetrics());
      await safe('ml', () => refreshML());
      await safe('mlBuckets', () => refreshMlBuckets());
      await safe('eod', () => refreshEod());
      await safe('logs', () => refreshLogs());

      // intervals
      setInterval(() => safe('health', () => refreshHealth()), 5000);
      setInterval(() => safe('config', () => refreshConfig()), 5000);
      setInterval(() => safe('processing', () => refreshProcessing()), 2000);
      setInterval(() => safe('tokens', () => refreshTokens()), 10000);
      setInterval(() => safe('ml', () => refreshML()), 20000);
      setInterval(() => safe('debit', () => refreshDebitSpreads()), 10000);
      setInterval(() => safe('debit_history', () => refreshDebitHistory()), 30000);

      // logs auto-refresh
      let logTimer;
      document.getElementById('logAuto').addEventListener('change', (ev) => {
        if (ev.target.checked) {
          logTimer = setInterval(() => safe('logs', () => refreshLogs()), 5000);
        } else {
          if (logTimer) clearInterval(logTimer);
        }
      });

      // queue controls
      document.getElementById('queueOrder')?.addEventListener('change', () => safe('processing', () => refreshProcessing()));
      document.getElementById('queuePage')?.addEventListener('change', () => safe('processing', () => refreshProcessing()));
      document.getElementById('queuePageSize')?.addEventListener('change', () => safe('processing', () => refreshProcessing()));

    })();
  </script>
</body>
</html>
