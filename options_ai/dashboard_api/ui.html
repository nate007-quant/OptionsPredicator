<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nate's Option Dashboard</title>

  <style>
    :root {
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --radius: 12px;
      --radius-sm: 10px;
      --shadow: 0 8px 24px rgba(0,0,0,0.18);
      --shadow-sm: 0 4px 14px rgba(0,0,0,0.14);
      --space-1: 6px;
      --space-2: 10px;
      --space-3: 14px;
      --space-4: 18px;
      --space-5: 24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

      --bg: #0b1020;
      --surface: #111a33;
      --surface-2: #0f1730;
      --text: #e7ecff;
      --muted: #a6b0d6;
      --border: rgba(255,255,255,0.10);
      --divider: rgba(255,255,255,0.06);

      --primary: #60a5fa;
      --primary-2: #2563eb;

      --success: #22c55e;
      --warn: #f59e0b;
      --error: #ef4444;
      --info: #38bdf8;

      --btn-bg: rgba(255,255,255,0.08);
      --btn-bg-hover: rgba(255,255,255,0.12);
      --btn-border: rgba(255,255,255,0.14);
    }

    html[data-theme="light"] {
      --bg: #f7f8fc;
      --surface: #ffffff;
      --surface-2: #f1f5ff;
      --text: #0b1020;
      --muted: #41507a;
      --border: rgba(15, 23, 42, 0.14);
      --divider: rgba(15, 23, 42, 0.08);

      --btn-bg: rgba(15, 23, 42, 0.06);
      --btn-bg-hover: rgba(15, 23, 42, 0.10);
      --btn-border: rgba(15, 23, 42, 0.16);

      --shadow: 0 10px 30px rgba(15,23,42,0.10);
      --shadow-sm: 0 6px 18px rgba(15,23,42,0.08);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
    }

    a { color: inherit; text-decoration: none; }

    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 56px 1fr;
      height: 100vh;
    }

    .appbar {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-4);
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(8px);
    }

    .brand {
      display: flex;
      gap: var(--space-3);
      align-items: center;
    }
    .logo {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      box-shadow: var(--shadow-sm);
    }
    .brand h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.2px;
    }
    .brand .sub {
      font-size: 12px;
      color: var(--muted);
    }

    .status {
      display: flex;
      gap: var(--space-3);
      align-items: center;
      font-size: 12px;
      color: var(--muted);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--warn);
      box-shadow: 0 0 0 3px rgba(245,158,11,0.18);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      color: var(--muted);
    }
    .badge strong { color: var(--text); font-weight: 600; }

    .sidebar {
      grid-row: 2;
      padding: var(--space-4);
      border-right: 1px solid var(--border);
      background: rgba(255,255,255,0.02);
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: var(--space-2);
    }

    .nav a {
      padding: 10px 12px;
      border-radius: 10px;
      color: var(--muted);
      border: 1px solid transparent;
    }

    .nav a.active {
      color: var(--text);
      background: rgba(96,165,250,0.12);
      border-color: rgba(96,165,250,0.30);
    }

    .nav a:hover {
      background: rgba(255,255,255,0.06);
    }

    .content {
      grid-row: 2;
      overflow: auto;
      padding: var(--space-4);
    }

    .banner {
      display: none;
      margin-bottom: var(--space-3);
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(239,68,68,0.35);
      background: rgba(239,68,68,0.12);
      color: var(--text);
      font-size: 12px;
      white-space: pre-wrap;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    .grid1 {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--space-4);
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .card .card-h {
      padding: 12px 14px;
      border-bottom: 1px solid var(--divider);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: var(--space-3);
    }

    .card .card-h h2 {
      margin: 0;
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    .card .card-h .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .card .card-b {
      padding: 14px;
    }

    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--text);
    }

    label { font-size: 12px; color: var(--muted); }

    input, select {
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--btn-border);
      border-radius: 10px;
      padding: 8px 10px;
      color: var(--text);
      outline: none;
    }
    input:focus, select:focus {
      border-color: rgba(96,165,250,0.55);
      box-shadow: 0 0 0 3px rgba(96,165,250,0.18);
    }

    button {
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover { background: var(--btn-bg-hover); }
    button:disabled { opacity: 0.55; cursor: not-allowed; }

    .btn-primary { background: rgba(96,165,250,0.18); border-color: rgba(96,165,250,0.35); }
    .btn-danger { background: rgba(239,68,68,0.16); border-color: rgba(239,68,68,0.34); }

    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead th {
      position: sticky;
      top: 0;
      background: var(--surface);
      border-bottom: 1px solid var(--divider);
      text-align: left;
      padding: 8px;
      color: var(--muted);
      font-weight: 600;
    }
    tbody td {
      border-bottom: 1px solid var(--divider);
      padding: 8px;
    }
    tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }
    tbody tr:hover { background: rgba(96,165,250,0.06); }

    .logs {
      max-height: 520px;
      overflow: auto;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      font-family: var(--mono);
      font-size: 12px;
    }
    .logs .line { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.06); }

    .toast-wrap {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    .toast {
      width: min(420px, calc(100vw - 40px));
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(17,26,51,0.92);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 12px;
    }

    .toast.success { border-color: rgba(34,197,94,0.35); }
    .toast.error { border-color: rgba(239,68,68,0.35); }
    .toast.warn { border-color: rgba(245,158,11,0.35); }

    .view { display: none; }
    .view.active { display: block; }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; grid-template-rows: 56px auto 1fr; }
      .sidebar { grid-row: 2; border-right: none; border-bottom: 1px solid var(--border); }
      .content { grid-row: 3; }
      .grid2 { grid-template-columns: 1fr; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="toast-wrap" id="toastWrap"></div>

  <div class="app">
    <div class="appbar">
      <div class="brand">
        <img src="/static/wolf.svg" alt="Wolf logo" class="logo"/>
        <h1>Nate's Option Dashboard</h1>
      </div>

      <div class="status">
        <div class="badge"><span class="dot" id="healthDot"></span> <strong id="healthText">Unknown</strong></div>
        <div class="badge">Paused: <strong id="pausedText">—</strong></div>
        <div class="badge">Last refresh: <strong id="lastRefresh">—</strong></div>
        <button id="themeToggle">Theme</button>
      </div>
    </div>

    <aside class="sidebar">
      <div class="badge" style="width:100%; justify-content:space-between;">
        <span>Navigation</span>
        <span style="font-family:var(--mono); font-size:11px;" id="apiTz">CT</span>
      </div>
      <nav class="nav" id="nav">
        <a href="#overview" data-view="overview" class="active">Overview</a>
        <a href="#debit" data-view="debit">Debit Spreads</a>
        <a href="#backtest" data-view="backtest">Backtest</a>
        <a href="#processing" data-view="processing">Processing</a>
        <a href="#timeseries" data-view="timeseries">Time Series</a>
        <a href="#logs" data-view="logs">Logs</a>
        <a href="#controls" data-view="controls">Controls & Admin</a>
      </nav>
    </aside>

    <main class="content">
      <div class="banner" id="errorBanner"></div>

      <!-- OVERVIEW -->
      <section class="view active" id="view-overview">
        <div class="grid2">
          <div class="card">
            <div class="card-h"><h2>Processing</h2><div class="hint">Queue + scoring status</div></div>
            <div class="card-b">
              <div class="row">
                <div>Queue: <span id="queueCount" class="pill">-</span></div>
                <div>Processing: <span id="procCount" class="pill">-</span></div>
                <div>Total predictions: <span id="totPred" class="pill">-</span></div>
                <div>Scored: <span id="totScored" class="pill">-</span></div>
                <div>Unscored: <span id="totUnscored" class="pill">-</span></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <div class="badge">Newest snapshot_index: <strong id="newestSnap">—</strong></div>
                <div class="badge">Oldest unscored: <strong id="oldestUnscored">—</strong></div>
              </div>
              <div style="margin-top:10px; color:var(--muted); font-size:12px;" id="processingBox">(idle)</div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>Tokens / Hour (est.)</h2><div class="hint">Estimated from chars (DeepSeek endpoint doesn’t return usage)</div></div>
            <div class="card-b">
              <div style="display:flex; justify-content:space-between; align-items:baseline;">
                <div style="font-size:38px; font-weight:750;" id="tokTotal">—</div>
                <div style="text-align:right;">
                  <div class="hint" id="tokAvg">avg/file: —</div>
                  <div class="hint" id="tokTrend">trend: —</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top: var(--space-4);">
          <div class="card">
            <div class="card-h"><h2>LLM Rolling (N)</h2><div class="hint">Bucketed by observed_ts_utc (event time)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Rolling N <input id="rollingN" type="number" min="10" max="5000" value="50" style="width:90px;" /></label>
                <button class="btn-primary" id="refreshMetrics">Refresh</button>
                <span class="hint" id="metricsAsOf"></span>
              </div>
              <div class="row" style="margin-top:10px;">
                <div>Overall: <span id="rollOverall" class="pill">—</span></div>
                <div>Excl inconc: <span id="rollExcl" class="pill">—</span></div>
                <div>Hi-conf: <span id="rollHi" class="pill">—</span></div>
                <div>Total: <span id="rollTotal" class="pill">—</span></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>ML Rolling (N)</h2><div class="hint">Neutral-often / action gating</div></div>
            <div class="card-b">
              <div class="row" style="margin-top:4px;">
                <div>Action rate: <span id="mlActionRate" class="pill">—</span></div>
                <div>Acc (actionable): <span id="mlAccAction" class="pill">—</span></div>
                <div>Overall acc: <span id="mlOverall" class="pill">—</span></div>
                <div>Scored: <span id="mlTotal" class="pill">—</span></div>
              </div>
              <div class="hint" style="margin-top:10px;">See Models tab for charts.</div>
            </div>
          </div>


          <div class="card" style="margin-top: var(--space-4);">
            <div class="card-h">
              <h2>Trade History (30m)</h2>
              <div class="hint">Realized outcomes; optional “only trades I'd take” filter</div>
            </div>
            <div class="card-b">
              <div class="row">
                <label>Limit <input id="debitHistLimit" type="number" min="1" max="500" value="100" style="width:90px;" /></label>
                <label><input id="debitHistOnlyReco" type="checkbox" /> Only trades I'd take</label>
                <button class="btn-primary" id="refreshDebitHistoryBtn">Refresh</button>
                <span class="hint" id="debitHistSummary"></span>
              </div>
              <div style="margin-top:12px;">
                <table>
                  <thead>
                    <tr>
                      <th>snapshot</th><th>anchor</th><th>type</th>
                      <th>debit_t</th><th>debit_tH</th><th>chg</th><th>roi</th>
                      <th>p(bigwin)</th><th>pred(30m)</th>
                    </tr>
                  </thead>
                  <tbody id="debitHistTable"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- PROCESSING -->
      <section class="view" id="view-processing">
        <div class="grid1">
          <div class="card">
            <div class="card-h">
              <h2>Processing</h2>
              <div class="hint">Queue oldest-first + paging</div>
            </div>
            <div class="card-b">
              <div class="row" style="justify-content:space-between;">
                <div class="row">
                  <div>Queue: <span class="pill" id="queueCount2">—</span></div>
                  <div>Processing: <span class="pill" id="procCount2">—</span></div>
                </div>
                <div class="row">
                  <label>Order
                    <select id="queueOrder">
                      <option value="oldest" selected>Oldest</option>
                      <option value="newest">Newest</option>
                    </select>
                  </label>
                  <label>Page <input id="queuePage" type="number" min="1" value="1" style="width:70px;" /></label>
                  <label>Page size <input id="queuePageSize" type="number" min="10" max="200" value="50" style="width:80px;" /></label>
                  <button id="refreshProcessingBtn">Refresh</button>
                </div>
              </div>

              <div style="margin-top:10px;">
                <table>
                  <thead><tr><th>file</th><th>size</th><th>mtime</th></tr></thead>
                  <tbody id="queueTable"></tbody>
                </table>
              </div>

              <div style="margin-top:14px;" class="row">
                <div class="badge">Newest snapshot_index: <strong id="newestSnap2">—</strong></div>
                <div class="badge">Oldest unscored: <strong id="oldestUnscored2">—</strong></div>
              </div>

              <div style="margin-top:12px;" class="badge">Currently processing: <strong id="processingBox2">—</strong></div>
            </div>
          </div>
        </div>
      </section>

      <!-- TIME SERIES -->
      <section class="view" id="view-timeseries">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>LLM Metrics</h2><div class="hint">15m buckets + daily (event time)</div></div>
            <div class="card-b">
          <div class="card">
            <div class="card-h"><h2>LLM Metrics</h2><div class="hint">Bucketed by observed_ts_utc (event time)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Window days <input id="llmWinDays" type="number" min="1" max="60" value="15" style="width:80px;" /></label>
                <label>Bucket
                  <select id="llmBucketMin">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="30">30</option>
                    <option value="60">60</option>
                  </select>
                </label>
                <label>Min samples <input id="llmMinSamples" type="number" min="1" max="200" value="5" style="width:80px;" /></label>
                <button class="btn-primary" id="refreshLlmBuckets">Refresh 15m</button>
              </div>
              <div style="margin-top:12px;">
                <canvas id="llmBucketChart" height="120"></canvas>
              </div>

              <div style="margin-top:16px;">
                <canvas id="dailyChart" height="120"></canvas>
              </div>
            </div>
          </div>
        
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>ML Metrics</h2><div class="hint">15m buckets + daily + EOD (Central)</div></div>
            <div class="card-b">
          <div class="card">
            <div class="card-h"><h2>ML (15m)</h2><div class="hint">Bucketed by observed_ts_utc</div></div>
            <div class="card-b">
              <div class="row">
                <label>Window days <input id="mlWinDays" type="number" min="1" max="60" value="15" style="width:80px;" /></label>
                <label>Bucket
                  <select id="mlBucketMin">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                    <option value="30">30</option>
                    <option value="60">60</option>
                  </select>
                </label>
                <label>Min samples <input id="mlMinSamples" type="number" min="1" max="200" value="5" style="width:80px;" /></label>
                <button class="btn-primary" id="refreshMlBuckets">Refresh 15m</button>
              </div>
              <div style="margin-top:12px;">
                <canvas id="mlBucketChart" height="120"></canvas>
              </div>
              <div style="margin-top:16px;">
                <canvas id="mlDailyChart" height="120"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>ML EOD (Early 60m)</h2><div class="hint">trade_day bucket (Central)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Variant
                  <select id="eodVariant">
                    <option value="lvl0" selected>lvl0</option>
                    <option value="lvl1">lvl1</option>
                  </select>
                </label>
                <label>Days <input id="eodDays" type="number" min="5" max="120" value="30" style="width:80px;" /></label>
                <button class="btn-primary" id="refreshEod">Refresh</button>
              </div>
              <div class="row" style="margin-top:10px;">
                <div>Action rate: <span id="eodActionRate" class="pill">—</span></div>
                <div>Acc (actionable): <span id="eodAccAction" class="pill">—</span></div>
                <div>Overall acc: <span id="eodOverall" class="pill">—</span></div>
              </div>
              <div style="margin-top:14px;">
                <canvas id="eodDailyChart" height="120"></canvas>
              </div>
            </div>
          </div>
        
            </div>
          </div>
        </div>
      </section>

      

      <!-- DEBIT SPREADS -->
      <section class="view" id="view-debit">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>0DTE Levels</h2><div class="hint">ATM / Call Wall / Put Wall / Magnet</div></div>
            <div class="card-b">
              <div class="row">
                <div class="badge">Snapshot: <strong id="debitSnapshot">—</strong></div>
                <div class="badge">Exp: <strong id="debitExp">—</strong></div>
                <div class="badge">Spot: <strong id="debitSpot">—</strong></div>
              </div>
              <div class="row" style="margin-top:10px;">
                <div class="badge">ATM: <strong id="lvlAtm">—</strong></div>
                <div class="badge">CALL_WALL: <strong id="lvlCallWall">—</strong></div>
                <div class="badge">PUT_WALL: <strong id="lvlPutWall">—</strong></div>
                <div class="badge">MAGNET: <strong id="lvlMagnet">—</strong></div>
              </div>
            </div>
          <div class="card">
            <div class="card-h"><h2>Daily Pick (first 30m)</h2><div class="hint">1 trade/day (objective: p(bigwin) then pred(30m); requires pred(30m) > 0)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Window (min) <input id="dailyPickWindow" type="number" min="5" max="180" value="30" style="width:90px;" /></label>
                <label>Min p(bigwin) <input id="dailyPickMinP" type="number" step="0.01" min="0" max="1" value="0.00" style="width:90px;" /></label>
                <label>Min pred(30m) <input id="dailyPickMinPred" type="number" step="0.01" value="0.00" style="width:90px;" /></label>
                <button class="btn-primary" id="refreshDailyPick">Refresh</button>
                <span class="hint" id="dailyPickNote"></span>
              </div>
              <pre id="dailyPickBox" style="margin-top:10px; font-family: var(--mono); font-size: 12px; color: var(--muted);">(loading)</pre>
            </div>
          </div>

          </div>

          <div class="card">
            <div class="card-h"><h2>Top Tradable Candidates</h2><div class="hint">tradable=true (ranked by 30m change when available, else debit)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Limit <input id="debitLimit" type="number" min="1" max="100" value="12" style="width:90px;" /></label>
                <button class="btn-primary" id="refreshDebit">Refresh</button>
                <span class="hint" id="debitNote"></span>
              </div>
              <div style="margin-top:12px;">
                <table>
                  <thead>
                    <tr>
                      <th>anchor</th>
                      <th>type</th>
                      <th>k_long</th>
                      <th>k_short</th>
                      <th>debit</th>
                      <th>p(bigwin)</th>
                      <th>pred(30m)</th>
                      <th>chg(30m)</th>
                      <th>long_symbol</th>
                      <th>short_symbol</th>
                    </tr>
                  </thead>
                  <tbody id="debitTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>



      <!-- BACKTEST -->
      <section class="view" id="view-backtest">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>Backtester — 0DTE Debit Spreads</h2><div class="hint">Timescale-backed (mid-based). Entry selection uses ML scores.</div></div>
            <div class="card-b">
              <div class="row">
                <label>Start <input id="btStart" type="date" /></label>
                <label>Strategy
                  <select id="btStrategyMode">
                    <option value="anchor_based" selected>Anchor-based</option>
                    <option value="structural_walls">Structural Walls</option>
                  </select>
                </label>
                <label>End <input id="btEnd" type="date" /></label>
                <label>Horizon(min) <input id="btH" type="number" min="5" max="180" value="30" style="width:90px;" /></label>
                <label>Entry mode
                  <select id="btEntryMode">
                    <option value="time_range" selected>time_range</option>
                    <option value="first_n_minutes">first_n_minutes</option>
                  </select>
                </label>
              </div>

              <div class="row" style="margin-top:10px;">
                <label>Session start (CT) <input id="btSessionStart" type="text" value="08:30" style="width:90px;" /></label>
                <label>First N (min) <input id="btFirstN" type="number" min="5" max="180" value="60" style="width:90px;" /></label>
                <label>Entry start (CT) <input id="btEntryStart" type="text" value="08:40" style="width:90px;" /></label>
                <label>Entry end (CT) <input id="btEntryEnd" type="text" value="09:30" style="width:90px;" /></label>
              </div>

              <div class="row" style="margin-top:10px;" id="btStructuralControls" style="display:none;">
                <label><input id="btEnablePW" type="checkbox" checked /> Enable PW trade (bearish PUT)</label>
                <label><input id="btEnableCW" type="checkbox" checked /> Enable CW trade (bullish CALL)</label>
                <label>Long moneyness
                  <select id="btLongMoneyness">
                    <option value="ATM" selected>ATM</option>
                    <option value="1_ITM">1_ITM</option>
                  </select>
                </label>
                <label>Max width <input id="btMaxWidth" type="number" value="25" style="width:90px;" /></label>
                <label>Min width <input id="btMinWidth" type="number" value="5" style="width:90px;" /></label>
                <label>Prox max <input id="btProxMax" type="number" value="30" style="width:90px;" /></label>
                <label>Rotation
                  <select id="btRotation">
                    <option value="spot_delta_5m" selected>spot_delta_5m</option>
                    <option value="none">none</option>
                  </select>
                </label>
              </div>

              <div class="row" style="margin-top:10px;" id="btStructuralOffsets" style="display:none;">
                <label>Short put offset (steps) <input id="btShortPutOffset" type="number" value="0" style="width:90px;" /></label>
                <label>Short call offset (steps) <input id="btShortCallOffset" type="number" value="0" style="width:90px;" /></label>
              </div>

<div class="row" style="margin-top:10px;">
                <label>Max trades/day <input id="btMaxPerDay" type="number" min="1" max="10" value="1" style="width:90px;" /></label>
                <label><input id="btOneAtATime" type="checkbox" checked /> One trade at a time</label>
                <label>Anchor mode
                  <select id="btAnchorMode">
                    <option value="ATM" selected>ATM</option>
                    <option value="WALLS">WALLS</option>
                    <option value="MAGNET">MAGNET</option>
                    <option value="ALL">ALL</option>
                  </select>
                </label>
                <label>Anchor policy
                  <select id="btAnchorPolicy">
                    <option value="any">any</option>
                    <option value="opposite_wall" selected>opposite_wall</option>
                    <option value="same_wall">same_wall</option>
                  </select>
                </label>
              </div>

              <div class="row" style="margin-top:10px;">
                <label>Min p(bigwin) <input id="btMinP" type="number" step="0.01" min="0" max="1" value="0.00" style="width:90px;" /></label>
                <label>Min pred(30m) <input id="btMinPred" type="number" step="0.01" value="0.00" style="width:90px;" /></label>
                <label>Max debit <input id="btMaxDebit" type="number" step="0.01" value="5.00" style="width:90px;" /></label>
                <label>Stop loss % <input id="btSL" type="number" step="0.01" value="0.50" style="width:90px;" /></label>
                <label>Take profit % <input id="btTP" type="number" step="0.01" value="2.00" style="width:90px;" /></label>
              </div>



              <div class="row" style="margin-top:10px;">
                <label>Presets
                  <select id="btPresetSelect" style="min-width:240px;">
                    <option value="">(no preset)</option>
                  </select>
                </label>
                <button id="btPresetSave" disabled>Save</button>
                <button id="btPresetSaveAs">Save As…</button>
                <button class="btn-danger" id="btPresetDelete" disabled>Delete</button>
                <span class="hint" id="btPresetLastRun"></span>
              </div>
              <div class="row" style="margin-top:12px;">
                <button class="btn-primary" id="runBacktest">Run Backtest</button>
                <span class="hint" id="btNote"></span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>Summary</h2><div class="hint">PnL uses multiplier 100; mid-based; snapshot-level exits</div></div>
            <div class="card-b">
              <pre id="btSummary" style="font-family:var(--mono); font-size:12px;">(run to see results)</pre>
              <div style="margin-top:12px;">
                <canvas id="btEquityChart" height="120"></canvas>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>Trades</h2><div class="hint">Entries are chosen by p(bigwin) desc, pred_change desc, debit asc (and pred_change&gt;0)</div></div>
            <div class="card-b">
              <div style="overflow:auto;">
                <table>
                  <thead>
                    <tr>
                      <th>day</th><th>entry</th><th>exit</th><th>reason</th>
                      <th>anchor</th><th>type</th><th>debit_in</th><th>debit_out</th>
                      <th>chg</th><th>pnl$</th><th>roi</th>
                      <th>p(bigwin)</th><th>pred(30m)</th>
                    </tr>
                  </thead>
                  <tbody id="btTrades"></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>


          <div class="card">
            <div class="card-h"><h2>Backtest Runs</h2><div class="hint">Server-persisted history (SQLite). Click a run row to load params.</div></div>
            <div class="card-b">
              <div class="row">
                <label>Show
                  <select id="btRunsScope">
                    <option value="all" selected>All runs</option>
                    <option value="preset">Selected preset</option>
                  </select>
                </label>
                <label>Limit <input id="btRunsLimit" type="number" value="200" min="10" max="2000" style="width:90px;" /></label>
                <button class="btn-primary" id="btRunsRefresh">Refresh</button>
                <span class="hint" id="btRunsNote"></span>
              </div>
              <div style="overflow:auto; margin-top:12px;">
                <table>
                  <thead>
                    <tr>
                      <th>created_at</th>
                      <th>preset</th>
                      <th>start</th>
                      <th>end</th>
                      <th>H</th>
                      <th>trades</th>
                      <th>total_pnl</th>
                      <th>win_rate</th>
                      <th>max_dd</th>
                    </tr>
                  </thead>
                  <tbody id="btRunsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
      </section>

<!-- LOGS -->
      <section class="view" id="view-logs">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>Logs</h2><div class="hint">Tail-only (whitelisted)</div></div>
            <div class="card-b">
              <div class="row">
                <label>Log
                  <select id="logName">
                    <option value="errors">errors</option>
                    <option value="system">system</option>
                    <option value="routing">routing</option>
                    <option value="model">model</option>
                    <option value="scoring">scoring</option>
                    <option value="performance">performance</option>
                    <option value="bootstrap">bootstrap</option>
                  </select>
                </label>
                <label>Lines <input id="logLimit" type="number" min="10" max="2000" value="200" style="width:90px;" /></label>
                <label>Search <input id="logSearch" type="text" placeholder="filter (client-side)" /></label>
                <label><input id="logAuto" type="checkbox" /> auto-refresh</label>
                <button class="btn-primary" id="refreshLogs">Refresh</button>
              </div>
              <div class="logs" id="logBox" style="margin-top: 12px;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CONTROLS -->
      <section class="view" id="view-controls">
        <div class="grid1">
          <div class="card">
            <div class="card-h"><h2>Runtime Controls</h2><div class="hint">Always visible (may be gated/disabled)</div></div>
            <div class="card-b">
              <div class="row">
                <label><input id="llmEnabled" type="checkbox" /> LLM_ENABLED</label>
                <label><input id="mlEnabled" type="checkbox" /> ML_ENABLED</label>
                <label><input id="chartEnabled" type="checkbox" /> CHART_ENABLED (requires LLM)</label>
                <label><input id="pauseProcessing" type="checkbox" /> PAUSE_PROCESSING</label>
              </div>

              <div class="row" style="margin-top:12px;">
                <label>REPROCESS_MODE
                  <select id="reprocessMode">
                    <option value="none">none</option>
                    <option value="from_model">from_model</option>
                    <option value="from_summary">from_summary</option>
                    <option value="from_signals">from_signals</option>
                    <option value="full">full</option>
                  </select>
                </label>
                <label>WATCH_POLL_SECONDS <input id="watchPoll" type="number" step="0.05" min="0.05" max="60" value="1" style="width:90px;" /></label>
                <label>FILE_STABLE_SECONDS <input id="fileStable" type="number" min="0" max="60" value="2" style="width:90px;" /></label>
                <label>OUTCOME_DELAY <input id="outcomeDelay" type="number" min="1" max="240" value="15" style="width:90px;" /></label>
              </div>

              <div class="row" style="margin-top:12px;">
                <button class="btn-primary" id="applyOverrides">Apply</button>
                <button id="clearReprocess">Clear REPROCESS override</button>
                <span class="hint" id="cfgStatus"></span>
              </div>

              <div style="margin-top:12px;" class="badge">Effective config snippet: <strong id="cfgSnippetInline">(loading)</strong></div>
            </div>
          </div>

          <div class="card">
            <div class="card-h"><h2>Admin</h2><div class="hint">Danger zone</div></div>
            <div class="card-b">
              <div style="color:var(--muted); font-size:12px;">Irreversible. Deletes DB rows + files. Requires PAUSE_PROCESSING=true and typed confirmation.</div>
              <div class="row" style="margin-top:12px;">
                <input id="resetConfirm" type="text" placeholder="Type: RESET ALL DATA" style="min-width:240px;" />
                <button class="btn-danger" id="runReset">Run Full Reset</button>
                <span class="hint" id="resetGateText">(loading gate)</span>
              </div>
              <pre id="resetStatus" style="margin-top:10px; font-family: var(--mono); font-size: 12px; color: var(--muted);">(reset output)</pre>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    const api = '';

    function setTheme(theme) {
      const t = theme === 'light' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
    }

    function initTheme() {
      const saved = localStorage.getItem('theme');
      setTheme(saved || 'dark');
    }

    function toast(msg, kind='success') {
      const wrap = document.getElementById('toastWrap');
      if (!wrap) return;
      const el = document.createElement('div');
      el.className = `toast ${kind}`;
      el.textContent = msg;
      wrap.appendChild(el);
      setTimeout(() => el.remove(), 4500);
    }

    function showError(where, err) {
      const b = document.getElementById('errorBanner');
      if (!b) return;
      const msg = (err && (err.message || err.toString())) ? (err.message || err.toString()) : String(err);
      const t = new Date().toISOString();
      b.style.display = 'block';
      b.textContent = `[${t}] ${where}: ${msg}`;
    }

    async function safe(where, fn) {
      try {
        const r = await fn();
        // stamp last refresh if it succeeded
        document.getElementById('lastRefresh').textContent = new Date().toLocaleString();
        return r;
      } catch (e) {
        console.error(where, e);
        showError(where, e);
        return null;
      }
    }

    function chartsAvailable() {
      return (typeof Chart !== 'undefined');
    }

    function fmtNum(x, nd=2) {
      if (x === null || x === undefined) return '—';
      const v = Number(x);
      if (!isFinite(v)) return '—';
      return v.toFixed(nd);
    }

    function fmtPct(x) {
      if (x === null || x === undefined) return '—';
      return (100.0 * x).toFixed(1) + '%';
    }

    async function jget(path) {
      const r = await fetch(api + path);
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function jpatch(path, obj) {
      const r = await fetch(api + path, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(obj)
      });
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function jpost(path, obj) {
      const r = await fetch(api + path, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(obj)
      });
      const txt = await r.text();
      if (!r.ok) throw new Error(txt);
      try { return JSON.parse(txt); } catch { return {raw: txt}; }
    }

    async function jput(path, obj) {
      const r = await fetch(api + path, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(obj)
      });
      const txt = await r.text();
      if (!r.ok) throw new Error(txt);
      try { return JSON.parse(txt); } catch { return {raw: txt}; }
    }

    async function jdel(path) {
      const r = await fetch(api + path, { method: 'DELETE' });
      const txt = await r.text();
      if (!r.ok) throw new Error(txt);
      try { return JSON.parse(txt); } catch { return {raw: txt}; }
    }

    function setActiveView(view) {
      document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
      const v = document.getElementById(`view-${view}`);
      if (v) v.classList.add('active');

      document.querySelectorAll('#nav a').forEach(a => a.classList.remove('active'));
      const link = document.querySelector(`#nav a[data-view="${view}"]`);
      if (link) link.classList.add('active');
    }

    function routeFromHash() {
      const h = (window.location.hash || '#overview').replace('#','');
      const allowed = new Set(['overview','debit','backtest','processing','timeseries','logs','controls']);
      setActiveView(allowed.has(h) ? h : 'overview');
    }

    // Health + gating
    let resetEnabled = false;

    async function refreshHealth() {
      const data = await jget('/api/health');
      const ok = !!data.ok;
      resetEnabled = !!data.reset_enabled;
      const paused = !!data.paused;

      const apiTzEl = document.getElementById('apiTz');
      if (apiTzEl) apiTzEl.textContent = data.tz === 'America/Chicago' ? 'CT' : (data.tz || '');
      const pausedEl = document.getElementById('pausedText');
      if (pausedEl) pausedEl.textContent = paused ? 'YES' : 'NO';

      const dot = document.getElementById('healthDot');
      const ht = document.getElementById('healthText');
      if (!dot || !ht) return data;
      if (!ok) {
        dot.style.background = 'var(--error)';
        dot.style.boxShadow = '0 0 0 3px rgba(239,68,68,0.18)';
        ht.textContent = 'DOWN';
      } else if (paused) {
        dot.style.background = 'var(--warn)';
        dot.style.boxShadow = '0 0 0 3px rgba(245,158,11,0.18)';
        ht.textContent = 'OK (paused)';
      } else {
        dot.style.background = 'var(--success)';
        dot.style.boxShadow = '0 0 0 3px rgba(34,197,94,0.18)';
        ht.textContent = 'OK';
      }

      const gateText = document.getElementById('resetGateText');
      const btn = document.getElementById('runReset');
      if (gateText && btn) {
        if (!resetEnabled) {
          gateText.textContent = 'RESET_ENABLED=false on server (enable in /opt/OptionsPredicator/.env)';
          btn.disabled = true;
        } else {
          gateText.textContent = 'RESET_ENABLED=true (still requires PAUSE_PROCESSING + typed confirm)';
          btn.disabled = false;
        }
      }

      return data;
    }

    // Backtest
    let btEquityChart;
    let btPresetsData;


    function setDateDefaults() {
      const s = document.getElementById('btStart');
      const e = document.getElementById('btEnd');
      if (!s || !e) return;
      const now = new Date();
      const end = new Date(now.getTime() - 24*3600*1000); // default: yesterday
      const start = new Date(end.getTime() - 5*24*3600*1000);
      const fmt = (d) => d.toISOString().slice(0,10);
      if (!s.value) s.value = fmt(start);
      if (!e.value) e.value = fmt(end);
    }

    function renderBtEquity(curve) {
      if (!chartsAvailable()) return;
      const ctx = document.getElementById('btEquityChart');
      if (!ctx) return;
      const labels = (curve || []).map(x => x.ts);
      const vals = (curve || []).map(x => x.cum_pnl_dollars);
      if (!btEquityChart) {
        btEquityChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: 'Cum PnL ($)', data: vals, borderColor: '#60a5fa', tension: 0.2 }] },
          options: { responsive: true, plugins: { legend: { display: true } }, scales: { x: { display: false } } }
        });
      } else {
        btEquityChart.data.labels = labels;
        btEquityChart.data.datasets[0].data = vals;
        btEquityChart.update();
      }
    }

    function updateBtMode() {
      const mode = document.getElementById('btStrategyMode')?.value || 'anchor_based';
      const show = (mode === 'structural_walls');
      const sc = document.getElementById('btStructuralControls');
      const so = document.getElementById('btStructuralOffsets');
      if (sc) sc.style.display = show ? '' : 'none';
      if (so) so.style.display = show ? '' : 'none';
    }

    function btStrategyKey() {
      const mode = document.getElementById('btStrategyMode')?.value || 'anchor_based';
      return `debit_spreads:${mode}`;
    }

    function btReadFormPayload() {
      setDateDefaults();
      updateBtMode();
      return {
        strategy_mode: document.getElementById('btStrategyMode')?.value || 'anchor_based',
        start_day: document.getElementById('btStart')?.value,
        end_day: document.getElementById('btEnd')?.value,
        horizon_minutes: parseInt(document.getElementById('btH')?.value || '30', 10),
        entry_mode: document.getElementById('btEntryMode')?.value || 'time_range',
        session_start_ct: document.getElementById('btSessionStart')?.value || '08:30',
        entry_first_n_minutes: parseInt(document.getElementById('btFirstN')?.value || '60', 10),
        entry_start_ct: document.getElementById('btEntryStart')?.value || '08:40',
        entry_end_ct: document.getElementById('btEntryEnd')?.value || '09:30',
        max_trades_per_day: parseInt(document.getElementById('btMaxPerDay')?.value || '1', 10),
        one_trade_at_a_time: !!document.getElementById('btOneAtATime')?.checked,
        anchor_mode: document.getElementById('btAnchorMode')?.value || 'ATM',
        anchor_policy: document.getElementById('btAnchorPolicy')?.value || 'any',
        min_p_bigwin: parseFloat(document.getElementById('btMinP')?.value || '0'),
        min_pred_change: parseFloat(document.getElementById('btMinPred')?.value || '0'),
        enable_pw_trade: !!document.getElementById('btEnablePW')?.checked,
        enable_cw_trade: !!document.getElementById('btEnableCW')?.checked,
        long_leg_moneyness: document.getElementById('btLongMoneyness')?.value || 'ATM',
        max_width_points: parseFloat(document.getElementById('btMaxWidth')?.value || '25'),
        min_width_points: parseFloat(document.getElementById('btMinWidth')?.value || '5'),
        proximity_min_points: 0,
        proximity_max_points: parseFloat(document.getElementById('btProxMax')?.value || '30'),
        rotation_filter: document.getElementById('btRotation')?.value || 'spot_delta_5m',
        short_put_offset_steps: parseInt(document.getElementById('btShortPutOffset')?.value || '0', 10),
        short_call_offset_steps: parseInt(document.getElementById('btShortCallOffset')?.value || '0', 10),
        allowed_spreads: ['CALL','PUT'],
        max_debit_points: parseFloat(document.getElementById('btMaxDebit')?.value || '5'),
        stop_loss_pct: parseFloat(document.getElementById('btSL')?.value || '0.5'),
        take_profit_pct: parseFloat(document.getElementById('btTP')?.value || '2.0'),
        max_future_lookahead_minutes: 120,
        price_mode: 'mid'
      };
    }

    function btApplyPayloadToForm(p) {
      if (!p) return;
      const setv = (id, v) => { const el = document.getElementById(id); if (el && v !== undefined && v !== null) el.value = String(v); };
      const setc = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };

      setv('btStrategyMode', p.strategy_mode);
      setv('btStart', p.start_day);
      setv('btEnd', p.end_day);
      setv('btH', p.horizon_minutes);
      setv('btEntryMode', p.entry_mode);
      setv('btSessionStart', p.session_start_ct);
      setv('btFirstN', p.entry_first_n_minutes);
      setv('btEntryStart', p.entry_start_ct);
      setv('btEntryEnd', p.entry_end_ct);
      setv('btMaxPerDay', p.max_trades_per_day);
      setc('btOneAtATime', p.one_trade_at_a_time);
      setv('btAnchorMode', p.anchor_mode);
      setv('btAnchorPolicy', p.anchor_policy);
      setv('btMinP', p.min_p_bigwin);
      setv('btMinPred', p.min_pred_change);

      setc('btEnablePW', p.enable_pw_trade);
      setc('btEnableCW', p.enable_cw_trade);
      setv('btLongMoneyness', p.long_leg_moneyness);
      setv('btMaxWidth', p.max_width_points);
      setv('btMinWidth', p.min_width_points);
      setv('btProxMax', p.proximity_max_points);
      setv('btRotation', p.rotation_filter);
      setv('btShortPutOffset', p.short_put_offset_steps);
      setv('btShortCallOffset', p.short_call_offset_steps);

      setv('btMaxDebit', p.max_debit_points);
      setv('btSL', p.stop_loss_pct);
      setv('btTP', p.take_profit_pct);

      updateBtMode();
    }

    function btSelectedPresetId() {
      const sel = document.getElementById('btPresetSelect');
      if (!sel) return null;
      const v = (sel.value || '').trim();
      if (!v) return null;
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : null;
    }

    async function btReloadPresets() {
      const sk = btStrategyKey();
      const data = await jget(`/api/backtest/presets?strategy_key=${encodeURIComponent(sk)}`);
      const sel = document.getElementById('btPresetSelect');
      if (!sel) return data;

      const current = sel.value;
      sel.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '(no preset)';
      sel.appendChild(opt0);

      for (const it of (data.items || [])) {
        const opt = document.createElement('option');
        opt.value = String(it.id);
        opt.textContent = it.name;
        sel.appendChild(opt);
      }
      if (current) sel.value = current;

      btPresetsData = data;
      btUpdatePresetButtons(data);
      btRenderPresetLastRun(data);
      return data;
    }

    function btUpdatePresetButtons(presetsData) {
      const pid = btSelectedPresetId();
      const btnSave = document.getElementById('btPresetSave');
      const btnDel = document.getElementById('btPresetDelete');
      if (btnSave) btnSave.disabled = !(pid);
      if (btnDel) btnDel.disabled = !(pid);
    }

    function btRenderPresetLastRun(presetsData) {
      const pid = btSelectedPresetId();
      const el = document.getElementById('btPresetLastRun');
      if (!el) return;
      if (!pid) { el.textContent = ''; return; }
      const it = (presetsData?.items || []).find(x => String(x.id) === String(pid));
      if (!it) { el.textContent = ''; return; }
      if (!it.last_run_at_utc) { el.textContent = 'Last run: —'; return; }
      const trades = it.last_summary?.trades ?? it.last_summary?.n_trades;
      const pnl = it.last_summary?.total_pnl ?? it.last_summary?.total_pnl_dollars;
      const extra = (trades !== undefined || pnl !== undefined) ? ` (trades=${trades ?? '—'}, pnl=${pnl ?? '—'})` : '';
      el.textContent = `Last run: ${it.last_run_at_utc}${extra}`;
    }

    async function btPresetSaveAs() {
      const name = prompt('Preset name:');
      if (!name) return;
      const body = { strategy_key: btStrategyKey(), name: name, params: btReadFormPayload() };
      await jpost('/api/backtest/presets', body);
      const data = await btReloadPresets();
      // select newly created preset if name matches
      const sel = document.getElementById('btPresetSelect');
      const it = (data.items||[]).find(x => x.name === name.trim());
      if (sel && it) sel.value = String(it.id);
      btUpdatePresetButtons(data);
      btRenderPresetLastRun(data);
      toast('preset saved', 'success');
      await btRefreshRuns();
    }

    async function btPresetSave() {
      const pid = btSelectedPresetId();
      if (!pid) return;
      const ok = confirm('Overwrite preset params?');
      if (!ok) return;
      await jput(`/api/backtest/presets/${pid}`, { params: btReadFormPayload() });
      const data = await btReloadPresets();
      toast('preset updated', 'success');
      btUpdatePresetButtons(data);
      btRenderPresetLastRun(data);
      await btRefreshRuns();
    }

    async function btPresetDelete() {
      const pid = btSelectedPresetId();
      if (!pid) return;
      const ok = confirm('Delete preset?');
      if (!ok) return;
      await jdel(`/api/backtest/presets/${pid}`);
      const sel = document.getElementById('btPresetSelect');
      if (sel) sel.value = '';
      const data = await btReloadPresets();
      toast('preset deleted', 'success');
      btUpdatePresetButtons(data);
      btRenderPresetLastRun(data);
      await btRefreshRuns();
    }

    async function btRefreshRuns() {
      const note = document.getElementById('btRunsNote');
      if (note) note.textContent = 'loading…';

      const sk = btStrategyKey();
      const scope = document.getElementById('btRunsScope')?.value || 'all';
      const lim = parseInt(document.getElementById('btRunsLimit')?.value || '200', 10);
      let url = `/api/backtest/runs?strategy_key=${encodeURIComponent(sk)}&limit=${encodeURIComponent(String(lim))}`;
      if (scope === 'preset') {
        const pid = btSelectedPresetId();
        if (pid) url += `&preset_id=${encodeURIComponent(String(pid))}`;
      }

      const data = await jget(url);
      const tb = document.getElementById('btRunsTable');
      if (tb) {
        tb.innerHTML = '';
        for (const it of (data.items || [])) {
          const p = it.params || {};
          const sum = it.summary || {};
          const tr = document.createElement('tr');
          tr.style.cursor = 'pointer';
          const trades = sum.trades ?? sum.n_trades ?? '—';
          const pnl = sum.total_pnl_dollars ?? sum.total_pnl ?? '—';
          const wr = sum.win_rate ?? sum.winrate ?? null;
          const maxdd = sum.max_drawdown ?? sum.max_dd ?? null;
          tr.innerHTML = `
            <td>${it.created_at_utc || ''}</td>
            <td>${it.preset_name_at_run || '—'}</td>
            <td>${p.start_day || '—'}</td>
            <td>${p.end_day || '—'}</td>
            <td>${p.horizon_minutes ?? '—'}</td>
            <td>${trades}</td>
            <td>${pnl}</td>
            <td>${wr === null || wr === undefined ? '—' : (100*Number(wr)).toFixed(1)+'%'}</td>
            <td>${maxdd === null || maxdd === undefined ? '—' : String(maxdd)}</td>
          `;
          tr.addEventListener('click', () => {
            btApplyPayloadToForm(p);
            toast('loaded params from run', 'info');
          });
          tb.appendChild(tr);
        }
      }

      if (note) note.textContent = `runs: ${(data.items||[]).length}`;
      return data;
    }


    async function runBacktestDebitSpreads() {
      setDateDefaults();
      updateBtMode();
      const payload = btReadFormPayload();
      const pid = btSelectedPresetId();
      if (pid) payload.preset_id = pid;

      const note = document.getElementById('btNote');
      if (note) note.textContent = 'running…';

      const resp = await fetch('/api/backtest/debit_spreads/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const t = await resp.text();
        throw new Error(`backtest http ${resp.status}: ${t}`);
      }
      const data = await resp.json();

      const sum = document.getElementById('btSummary');
      if (sum) sum.textContent = JSON.stringify(data.summary || {}, null, 2);

      renderBtEquity(data.equity_curve || []);

      const tb = document.getElementById('btTrades');
      if (tb) {
        tb.innerHTML = '';
        for (const t of (data.trades || [])) {
          const tr = document.createElement('tr');
          const pnl = t.pnl_dollars;
          tr.innerHTML = `
            <td>${t.day_local||''}</td>
            <td>${t.entry_ts||''}</td>
            <td>${t.exit_ts||''}</td>
            <td>${t.exit_reason||''}</td>
            <td>${t.anchor_type||''}</td>
            <td>${t.spread_type||''}</td>
            <td>${t.entry_debit==null?'—':fmtNum(t.entry_debit,2)}</td>
            <td>${t.exit_debit==null?'—':fmtNum(t.exit_debit,2)}</td>
            <td>${t.change_points==null?'—':fmtNum(t.change_points,2)}</td>
            <td>${pnl==null?'—':fmtNum(pnl,2)}</td>
            <td>${t.roi==null?'—':(100*Number(t.roi)).toFixed(1)+'%'}</td>
            <td>${t.p_bigwin==null?'—':(100*Number(t.p_bigwin)).toFixed(1)+'%'}</td>
            <td>${t.pred_change==null?'—':fmtNum(t.pred_change,2)}</td>
          `;
          tb.appendChild(tr);
        }
      }

      if (note) note.textContent = `done: ${((data.trades||[]).length)} trades`;
      return data;
    }

// Debit spreads (TimescaleDB)
    async function refreshDailyPick() {
      const win = parseInt(document.getElementById('dailyPickWindow')?.value || '30', 10);
      const minP = parseFloat(document.getElementById('dailyPickMinP')?.value || '0');
      const minPred = parseFloat(document.getElementById('dailyPickMinPred')?.value || '0');
      const data = await jget(`/api/debit_spreads/daily_pick?window_minutes=${win}&min_p_bigwin=${minP}&min_pred_change=${minPred}`);
      const box = document.getElementById('dailyPickBox');
      if (box) box.textContent = JSON.stringify(data, null, 2);
      const note = document.getElementById('dailyPickNote');
      if (note) note.textContent = data.pick ? 'PICKED' : 'no pick (filters too strict or no data)';
      return data;
    }


    async function refreshDebitHistory() {
      const lim = parseInt(document.getElementById('debitHistLimit')?.value || '100', 10);
      const onlyReco = document.getElementById('debitHistOnlyReco')?.checked ? '1' : '0';
      const data = await jget(`/api/debit_spreads/history?limit=${lim}&horizon_minutes=30&only_recommended=${onlyReco}`);

      const tb = document.getElementById('debitHistTable');
      if (!tb) return data;
      tb.innerHTML = '';

      for (const it of (data.items || [])) {
        const tr = document.createElement('tr');
        const roi = (it.roi === null || it.roi === undefined) ? '—' : (100*Number(it.roi)).toFixed(1) + '%';
        const pbig = (it.p_bigwin === null || it.p_bigwin === undefined) ? '—' : (100*Number(it.p_bigwin)).toFixed(1) + '%';
        const pred = (it.pred_change === null || it.pred_change === undefined) ? '—' : fmtNum(it.pred_change, 2);
        tr.innerHTML = `
          <td>${it.snapshot_ts || ''}</td>
          <td>${it.anchor_type || ''}</td>
          <td>${it.spread_type || ''}</td>
          <td>${it.debit_t === null || it.debit_t === undefined ? '—' : fmtNum(it.debit_t, 2)}</td>
          <td>${it.debit_tH === null || it.debit_tH === undefined ? '—' : fmtNum(it.debit_tH, 2)}</td>
          <td>${it.change === null || it.change === undefined ? '—' : fmtNum(it.change, 2)}</td>
          <td>${roi}</td>
          <td>${pbig}</td>
          <td>${pred}</td>
        `;
        tb.appendChild(tr);
      }

      const sum = document.getElementById('debitHistSummary');
      if (sum) {
        const items = (data.items||[]);
        const uniq = new Set(items.map(x => x.snapshot_ts)).size;
        const mode = (onlyReco === '1') ? 'recommended' : 'all';
        sum.textContent = `${items.length} rows / ${uniq} snapshots (${mode})`;
      }
      return data;
    }


    async function refreshDebitSpreads() {
      const lim = parseInt(document.getElementById('debitLimit')?.value || '12', 10);
      const data = await jget(`/api/debit_spreads/top?limit=${lim}`);

      document.getElementById('debitSnapshot').textContent = data.snapshot_ts || '—';
      const lev = data.levels || {};
      document.getElementById('debitExp').textContent = lev.expiration_date || '—';
      document.getElementById('debitSpot').textContent = (lev.spot === null || lev.spot === undefined) ? '—' : fmtNum(lev.spot, 2);
      document.getElementById('lvlAtm').textContent = (lev.atm === null || lev.atm === undefined) ? '—' : fmtNum(lev.atm, 0);
      document.getElementById('lvlCallWall').textContent = (lev.call_wall === null || lev.call_wall === undefined) ? '—' : fmtNum(lev.call_wall, 0);
      document.getElementById('lvlPutWall').textContent = (lev.put_wall === null || lev.put_wall === undefined) ? '—' : fmtNum(lev.put_wall, 0);
      document.getElementById('lvlMagnet').textContent = (lev.magnet === null || lev.magnet === undefined) ? '—' : fmtNum(lev.magnet, 0);

      const tb = document.getElementById('debitTable');
      tb.innerHTML = '';
      for (const it of (data.candidates || [])) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.anchor_type || ''}</td>
          <td>${it.spread_type || ''}</td>
          <td>${it.k_long === null || it.k_long === undefined ? '—' : fmtNum(it.k_long, 0)}</td>
          <td>${it.k_short === null || it.k_short === undefined ? '—' : fmtNum(it.k_short, 0)}</td>
          <td>${it.debit_points === null || it.debit_points === undefined ? '—' : fmtNum(it.debit_points, 2)}</td>
          <td>${it.p_bigwin === null || it.p_bigwin === undefined ? '—' : (100*Number(it.p_bigwin)).toFixed(1) + '%'}</td>
          <td>${it.pred_change === null || it.pred_change === undefined ? '—' : fmtNum(it.pred_change, 2)}</td>
          <td>${it.change === null || it.change === undefined ? (it.is_missing_future ? '—' : '…') : fmtNum(it.change, 2)}</td>
          <td style="font-family:var(--mono); font-size:11px;">${it.long_symbol || ''}</td>
          <td style="font-family:var(--mono); font-size:11px;">${it.short_symbol || ''}</td>
        `;
        tb.appendChild(tr);
      }

      const note = document.getElementById('debitNote');
      if (note) {
        note.textContent = (data.snapshot_ts ? 'latest snapshot' : 'no data yet');
      }

      return data;
    }

// Processing
    async function refreshProcessing() {
      const order = document.getElementById('queueOrder')?.value || 'oldest';
      const page = parseInt(document.getElementById('queuePage')?.value || '1', 10);
      const page_size = parseInt(document.getElementById('queuePageSize')?.value || '50', 10);
      const data = await jget(`/api/status/processing?page=${page}&page_size=${page_size}&order=${order}`);

      // Overview counters
      document.getElementById('queueCount').textContent = data.queue.count;
      document.getElementById('procCount').textContent = data.processing.count;
      document.getElementById('totPred').textContent = data.counters.total_predictions;
      document.getElementById('totScored').textContent = data.counters.total_scored;
      document.getElementById('totUnscored').textContent = data.counters.unscored;

      // Processing page counters
      const qc2 = document.getElementById('queueCount2');
      const pc2 = document.getElementById('procCount2');
      if (qc2) qc2.textContent = data.queue.count;
      if (pc2) pc2.textContent = data.processing.count;

      document.getElementById('newestSnap').textContent = data.snapshot_index_newest_ts || '—';
      document.getElementById('oldestUnscored').textContent = data.oldest_unscored_ts || '—';
      const ns2 = document.getElementById('newestSnap2');
      const ou2 = document.getElementById('oldestUnscored2');
      if (ns2) ns2.textContent = data.snapshot_index_newest_ts || '—';
      if (ou2) ou2.textContent = data.oldest_unscored_ts || '—';

      // Queue table
      const tb = document.getElementById('queueTable');
      tb.innerHTML = '';
      for (const it of (data.queue.items || [])) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.file}</td><td>${it.size}</td><td>${new Date(it.mtime*1000).toISOString()}</td>`;
        tb.appendChild(tr);
      }

      // Currently processing
      const pbox = document.getElementById('processingBox');
      const pbox2 = document.getElementById('processingBox2');
      if ((data.processing.items || []).length === 0) {
        const msg = 'idle / not available';
        if (pbox) pbox.textContent = msg;
        if (pbox2) pbox2.textContent = msg;
      } else {
        const it = data.processing.items[0];
        const msg = `${it.file} | stage=${it.stage} | started=${it.started_at} | elapsed=${(it.elapsed_seconds ?? 0).toFixed(1)}s`;
        if (pbox) pbox.textContent = msg;
        if (pbox2) pbox2.textContent = msg;
      }

      return data;
    }

    // Tokens tile
    async function refreshTokens() {
      const data = await jget('/api/usage/tokens?hours=24');
      const s = data.summary || {};
      document.getElementById('tokTotal').textContent = (s.est_total_tokens_last_60m ?? 0).toLocaleString();
      const avg = s.avg_est_tokens_per_file_last_60m;
      document.getElementById('tokAvg').textContent = 'avg/file: ' + (avg === null || avg === undefined ? '—' : Math.round(avg).toLocaleString());
      const tr = s.trend_vs_prev_hour_pct;
      if (tr === null || tr === undefined) {
        document.getElementById('tokTrend').textContent = 'trend: —';
      } else {
        const pct = (100*tr).toFixed(1);
        document.getElementById('tokTrend').textContent = 'trend: ' + (tr>=0?'+':'') + pct + '% vs prev hr';
      }
      return data;
    }

    // LLM daily chart + rolling
    let dailyChart;
    async function refreshMetrics() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }

      const n = parseInt(document.getElementById('rollingN').value || '50', 10);
      const roll = await jget(`/api/metrics/rolling?n=${n}`);
      document.getElementById('metricsAsOf').textContent = roll.as_of ? `as_of ${roll.as_of}` : '';
      document.getElementById('rollOverall').textContent = fmtPct(roll.overall_accuracy);
      document.getElementById('rollExcl').textContent = fmtPct(roll.accuracy_excluding_inconclusive);
      document.getElementById('rollHi').textContent = fmtPct(roll.hi_accuracy);
      document.getElementById('rollTotal').textContent = roll.total_scored;

      const daily = await jget('/api/metrics/daily?days=30');
      const labels = daily.series.map(x => x.day).reverse();
      const overall = daily.series.map(x => x.overall_accuracy).reverse();
      const excl = daily.series.map(x => x.accuracy_excluding_inconclusive).reverse();

      const ctx = document.getElementById('dailyChart');
      if (!dailyChart) {
        dailyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'overall_accuracy', data: overall, borderColor: '#60a5fa', tension: 0.2 },
              { label: 'accuracy_excl_inconclusive', data: excl, borderColor: '#22c55e', tension: 0.2 },
            ]
          },
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        dailyChart.data.labels = labels;
        dailyChart.data.datasets[0].data = overall;
        dailyChart.data.datasets[1].data = excl;
        dailyChart.update();
      }

      return {roll, daily};
    }

    // LLM bucket series
    let llmBucketChart;
    async function refreshLlmBuckets() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }
      const wd = parseInt(document.getElementById('llmWinDays')?.value || '15', 10);
      const bm = parseInt(document.getElementById('llmBucketMin')?.value || '15', 10);
      const ms = parseInt(document.getElementById('llmMinSamples')?.value || '5', 10);
      const data = await jget(`/api/metrics/series_buckets?window_days=${wd}&bucket_minutes=${bm}&min_samples=${ms}`);
      const labels = (data.series || []).map(x => x.bucket_start);
      const overall = (data.series || []).map(x => x.overall_accuracy);
      const excl = (data.series || []).map(x => x.accuracy_excluding_inconclusive);

      const ctx = document.getElementById('llmBucketChart');
      if (!llmBucketChart) {
        llmBucketChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
            { label: 'overall_accuracy', data: overall, borderColor: '#38bdf8', tension: 0.15 },
            { label: 'accuracy_excl_inconclusive', data: excl, borderColor: '#22c55e', tension: 0.15 },
          ]},
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        llmBucketChart.data.labels = labels;
        llmBucketChart.data.datasets[0].data = overall;
        llmBucketChart.data.datasets[1].data = excl;
        llmBucketChart.update();
      }

      return data;
    }

    // ML charts
    let mlDailyChart;
    async function refreshML() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }

      const roll = await jget('/api/ml/metrics/rolling?n=50');
      document.getElementById('mlActionRate').textContent = fmtPct(roll.action_rate);
      document.getElementById('mlAccAction').textContent = fmtPct(roll.accuracy_actionable);
      document.getElementById('mlOverall').textContent = fmtPct(roll.overall_accuracy);
      document.getElementById('mlTotal').textContent = roll.total_scored;

      const daily = await jget('/api/ml/metrics/daily?days=30');
      const labels = daily.series.map(x => x.day).reverse();
      const action = daily.series.map(x => x.action_rate).reverse();
      const acc = daily.series.map(x => x.accuracy_actionable).reverse();

      const ctx = document.getElementById('mlDailyChart');
      if (!mlDailyChart) {
        mlDailyChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'action_rate', data: action, borderColor: '#f59e0b', tension: 0.2 },
              { label: 'accuracy_actionable', data: acc, borderColor: '#a855f7', tension: 0.2 },
            ]
          },
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        mlDailyChart.data.labels = labels;
        mlDailyChart.data.datasets[0].data = action;
        mlDailyChart.data.datasets[1].data = acc;
        mlDailyChart.update();
      }

      return {roll, daily};
    }

    let mlBucketChart;
    async function refreshMlBuckets() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }
      const wd = parseInt(document.getElementById('mlWinDays')?.value || '15', 10);
      const bm = parseInt(document.getElementById('mlBucketMin')?.value || '15', 10);
      const ms = parseInt(document.getElementById('mlMinSamples')?.value || '5', 10);
      const data = await jget(`/api/ml/metrics/series_buckets?window_days=${wd}&bucket_minutes=${bm}&min_samples=${ms}`);
      const labels = (data.series || []).map(x => x.bucket_start);
      const ar = (data.series || []).map(x => x.action_rate);
      const aa = (data.series || []).map(x => x.accuracy_actionable);

      const ctx = document.getElementById('mlBucketChart');
      if (!mlBucketChart) {
        mlBucketChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
            { label: 'action_rate', data: ar, borderColor: '#f59e0b', tension: 0.15 },
            { label: 'accuracy_actionable', data: aa, borderColor: '#a855f7', tension: 0.15 },
          ]},
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        mlBucketChart.data.labels = labels;
        mlBucketChart.data.datasets[0].data = ar;
        mlBucketChart.data.datasets[1].data = aa;
        mlBucketChart.update();
      }
      return data;
    }

    // EOD
    let eodDailyChart;
    async function refreshEod() {
      if (!chartsAvailable()) {
        showError('charts', 'Chart.js not available (CDN blocked/offline).');
        return;
      }
      const variant = document.getElementById('eodVariant')?.value || 'lvl0';
      const days = parseInt(document.getElementById('eodDays')?.value || '30', 10);
      const data = await jget(`/api/ml_eod/metrics/daily?days=${days}&variant=${variant}`);
      const series = (data.series || []).slice().reverse();
      const labels = series.map(x => x.day);
      const ar = series.map(x => x.action_rate);
      const aa = series.map(x => x.accuracy_actionable);

      const last = (data.series || [])[0] || {};
      document.getElementById('eodActionRate').textContent = fmtPct(last.action_rate);
      document.getElementById('eodAccAction').textContent = fmtPct(last.accuracy_actionable);
      document.getElementById('eodOverall').textContent = fmtPct(last.overall_accuracy);

      const ctx = document.getElementById('eodDailyChart');
      if (!eodDailyChart) {
        eodDailyChart = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [
            { label: 'action_rate', data: ar, borderColor: '#f97316', tension: 0.2 },
            { label: 'accuracy_actionable', data: aa, borderColor: '#06b6d4', tension: 0.2 },
          ]},
          options: { responsive: true, scales: { y: { min: 0, max: 1 } } }
        });
      } else {
        eodDailyChart.data.labels = labels;
        eodDailyChart.data.datasets[0].data = ar;
        eodDailyChart.data.datasets[1].data = aa;
        eodDailyChart.update();
      }
      return data;
    }

    // Logs
    async function refreshLogs() {
      const name = document.getElementById('logName').value;
      const limit = parseInt(document.getElementById('logLimit').value || '200', 10);
      const search = (document.getElementById('logSearch').value || '').toLowerCase();
      const data = await jget(`/api/logs/tail?name=${encodeURIComponent(name)}&limit=${limit}`);

      const box = document.getElementById('logBox');
      box.innerHTML = '';
      for (const l of (data.lines || [])) {
        const raw = l.raw || '';
        if (search && !raw.toLowerCase().includes(search)) continue;
        const div = document.createElement('div');
        div.className = 'line';
        div.textContent = raw;
        box.appendChild(div);
      }
      box.scrollTop = box.scrollHeight;
      return data;
    }

    // Config + overrides
    async function refreshConfig() {
      const data = await jget('/api/config');
      const eff = data.effective;

      document.getElementById('reprocessMode').value = eff.reprocess_mode;
      document.getElementById('watchPoll').value = eff.watch_poll_seconds;
      document.getElementById('fileStable').value = eff.file_stable_seconds;
      document.getElementById('outcomeDelay').value = eff.outcome_delay_minutes;

      document.getElementById('llmEnabled').checked = !!eff.llm_enabled;
      document.getElementById('mlEnabled').checked = !!eff.ml_enabled;
      document.getElementById('chartEnabled').checked = !!eff.chart_enabled;
      document.getElementById('pauseProcessing').checked = !!eff.pause_processing;

      const snippet = {
        pause_processing: eff.pause_processing,
        reprocess_mode: eff.reprocess_mode,
        watch_poll_seconds: eff.watch_poll_seconds,
        file_stable_seconds: eff.file_stable_seconds,
        outcome_delay_minutes: eff.outcome_delay_minutes,
        llm_enabled: eff.llm_enabled,
        ml_enabled: eff.ml_enabled,
        chart_enabled: eff.chart_enabled,
        prompt_version: eff.prompt_version,
      };
      document.getElementById('cfgSnippetInline').textContent = JSON.stringify(snippet);

      // Sync paused badge in appbar
      document.getElementById('pausedText').textContent = eff.pause_processing ? 'YES' : 'NO';

      return data;
    }

    async function applyOverrides() {
      const payload = {
        LLM_ENABLED: !!document.getElementById('llmEnabled').checked,
        ML_ENABLED: !!document.getElementById('mlEnabled').checked,
        CHART_ENABLED: !!document.getElementById('chartEnabled').checked,
        PAUSE_PROCESSING: !!document.getElementById('pauseProcessing').checked,
        REPROCESS_MODE: document.getElementById('reprocessMode').value,
        WATCH_POLL_SECONDS: parseFloat(document.getElementById('watchPoll').value),
        FILE_STABLE_SECONDS: parseInt(document.getElementById('fileStable').value, 10),
        OUTCOME_DELAY: parseInt(document.getElementById('outcomeDelay').value, 10),
      };

      const status = document.getElementById('cfgStatus');
      status.textContent = 'Applying...';
      await jpatch('/api/config', payload);
      status.textContent = 'Applied.';
      toast('Overrides applied', 'success');
      await refreshConfig();
    }

    async function clearReprocess() {
      const status = document.getElementById('cfgStatus');
      status.textContent = 'Clearing...';
      await jpatch('/api/config', {REPROCESS_MODE: null});
      status.textContent = 'Cleared.';
      toast('REPROCESS_MODE cleared', 'success');
      await refreshConfig();
    }

    async function runFullReset() {
      const out = document.getElementById('resetStatus');
      out.textContent = 'Running reset...';

      const confirm = document.getElementById('resetConfirm').value || '';
      const r = await jpost('/api/admin/reset_all', {confirm});
      out.textContent = JSON.stringify(r, null, 2);
      toast('Reset completed (check output)', 'warn');

      // refresh UI after reset
      await safe('refreshConfig', () => refreshConfig());
      await safe('refreshProcessing', () => refreshProcessing());
      await safe('refreshLogs', () => refreshLogs());
    }

    // wiring
    document.getElementById('themeToggle')?.addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-theme') || 'dark';
      setTheme(cur === 'dark' ? 'light' : 'dark');
    });

    document.getElementById('refreshMetrics')?.addEventListener('click', () => safe('refreshMetrics', () => refreshMetrics()));
    document.getElementById('refreshLlmBuckets')?.addEventListener('click', () => safe('refreshLlmBuckets', () => refreshLlmBuckets()));
    document.getElementById('refreshMlBuckets')?.addEventListener('click', () => safe('refreshMlBuckets', () => refreshMlBuckets()));
    document.getElementById('refreshEod')?.addEventListener('click', () => safe('refreshEod', () => refreshEod()));
    document.getElementById('refreshLogs')?.addEventListener('click', () => safe('refreshLogs', () => refreshLogs()));
    document.getElementById('refreshDebit')?.addEventListener('click', () => safe('refreshDebitSpreads', () => refreshDebitSpreads()));
    document.getElementById('refreshDailyPick')?.addEventListener('click', () => safe('daily_pick', () => refreshDailyPick()));
    document.getElementById('runBacktest')?.addEventListener('click', () => safe('backtest', () => runBacktestDebitSpreads()));

    document.getElementById('btPresetSelect')?.addEventListener('change', () => {
      // When a preset is selected, load its saved params into the form.
      const pid = btSelectedPresetId();
      if (pid && btPresetsData && Array.isArray(btPresetsData.items)) {
        const it = btPresetsData.items.find(x => String(x.id) === String(pid));
        if (it && it.params) {
          btApplyPayloadToForm(it.params);
          toast('loaded preset params', 'info');
        }
      }

      btUpdatePresetButtons(btPresetsData);
      btRenderPresetLastRun(btPresetsData);
      safe('bt_runs', () => btRefreshRuns());
    });
    document.getElementById('btStrategyMode')?.addEventListener('change', () => {
      updateBtMode();
      // Presets are keyed by strategy_mode; reload when strategy changes.
      safe('bt_presets', () => btReloadPresets());
      safe('bt_runs', () => btRefreshRuns());
    });
    document.getElementById('refreshDebitHistoryBtn')?.addEventListener('click', () => safe('debit_history', () => refreshDebitHistory()));
    document.getElementById('debitHistOnlyReco')?.addEventListener('change', () => safe('debit_history', () => refreshDebitHistory()));
    document.getElementById('applyOverrides')?.addEventListener('click', () => safe('applyOverrides', () => applyOverrides()));
    document.getElementById('clearReprocess')?.addEventListener('click', () => safe('clearReprocess', () => clearReprocess()));
    document.getElementById('runReset')?.addEventListener('click', () => safe('runReset', () => runFullReset()));

    document.getElementById('refreshProcessingBtn')?.addEventListener('click', () => safe('refreshProcessing', () => refreshProcessing()));

    // routing
    window.addEventListener('hashchange', routeFromHash);

    // initial load
    (async () => {
      initTheme();
      routeFromHash();

      await safe('health', () => refreshHealth());
      await safe('config', () => refreshConfig());
      await safe('tokens', () => refreshTokens());
      await safe('processing', () => refreshProcessing());
      await safe('debit', () => refreshDebitSpreads());
      await safe('daily_pick', () => refreshDailyPick());
      await safe('debit_history', () => refreshDebitHistory());
      await safe('llmBuckets', () => refreshLlmBuckets());
      await safe('llmMetrics', () => refreshMetrics());
      await safe('ml', () => refreshML());
      await safe('mlBuckets', () => refreshMlBuckets());
      await safe('eod', () => refreshEod());
      await safe('logs', () => refreshLogs());

      // Backtest UI: load server presets + recent runs (even if Backtest tab isn't active yet)
      await safe('bt_presets', () => btReloadPresets());
      await safe('bt_runs', () => btRefreshRuns());

      // intervals
      setInterval(() => safe('health', () => refreshHealth()), 5000);
      setInterval(() => safe('config', () => refreshConfig()), 5000);
      setInterval(() => safe('processing', () => refreshProcessing()), 2000);
      setInterval(() => safe('tokens', () => refreshTokens()), 10000);
      setInterval(() => safe('ml', () => refreshML()), 20000);
      setInterval(() => safe('debit', () => refreshDebitSpreads()), 10000);
      setInterval(() => safe('daily_pick', () => refreshDailyPick()), 30000);
      setInterval(() => safe('debit_history', () => refreshDebitHistory()), 30000);

      // logs auto-refresh
      let logTimer;
      document.getElementById('logAuto').addEventListener('change', (ev) => {
        if (ev.target.checked) {
          logTimer = setInterval(() => safe('logs', () => refreshLogs()), 5000);
        } else {
          if (logTimer) clearInterval(logTimer);
        }
      });

      // queue controls
      document.getElementById('queueOrder')?.addEventListener('change', () => safe('processing', () => refreshProcessing()));
      document.getElementById('queuePage')?.addEventListener('change', () => safe('processing', () => refreshProcessing()));
      document.getElementById('queuePageSize')?.addEventListener('change', () => safe('processing', () => refreshProcessing()));

    })();
  </script>
</body>
</html>
